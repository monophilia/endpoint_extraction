# レビューチェックリスト: レスポンス型抽出機能

Updated: 2025/12/30 06:15

## 概要

このファイルはレビューエージェントが参照する品質保証ファイルです。
各設計書の内容に対するレビュー観点を詳細に定義しています。

---

## レビュー観点一覧

| # | 観点ID | Phase | 対象設計書 | チェック内容 | 重要度 |
|---|--------|-------|-----------|-------------|--------|
| 1 | RESP-MODEL-001 | 1 | 02.models.md | ResponseInfo型にcodeフィールドがあること | HIGH |
| 2 | RESP-MODEL-002 | 1 | 02.models.md | ResponseInfo型にdataTypeフィールドがあること | HIGH |
| 3 | RESP-MODEL-003 | 1 | 02.models.md | ResponseInfo型にsourceフィールドがあること | HIGH |
| 4 | RESP-MODEL-004 | 1 | 02.models.md | ErrorResponseInfo型にcodeフィールドがあること | HIGH |
| 5 | RESP-MODEL-005 | 1 | 02.models.md | ErrorResponseInfo型にmessageフィールドがあること | HIGH |
| 6 | RESP-MODEL-006 | 1 | 02.models.md | EndpointInfo型にresponses?フィールドがあること | HIGH |
| 7 | RESP-MODEL-007 | 1 | 02.models.md | ExtractorOptions型にextractResponsesがあること | HIGH |
| 8 | RESP-MODEL-008 | 1 | 02.models.md | YamlEndpoint型にresponses?フィールドがあること | HIGH |
| 9 | RESP-MODEL-009 | 1 | 02.models.md | YamlResponses.errorsが配列形式であること | HIGH |
| 10 | RESP-TEST-001 | 1 | 03.tests.md | return文からの抽出テストがあること | HIGH |
| 11 | RESP-TEST-002 | 1 | 03.tests.md | reply.send()からの抽出テストがあること | HIGH |
| 12 | RESP-TEST-003 | 1 | 03.tests.md | reply.code().send()からの抽出テストがあること | HIGH |
| 13 | RESP-TEST-004 | 1 | 03.tests.md | エラーレスポンス分類テストがあること | HIGH |
| 14 | RESP-TEST-005 | 1 | 03.tests.md | エラーメッセージ抽出テストがあること | HIGH |
| 15 | RESP-IMPL-001 | 1 | 04.parser-implementation.md | ResponseExtractorクラスが存在すること | HIGH |
| 16 | RESP-IMPL-002 | 1 | 04.parser-implementation.md | extractFromHandlerメソッドがあること | HIGH |
| 17 | RESP-IMPL-003 | 1 | 04.parser-implementation.md | parseSendCallメソッドがあること | HIGH |
| 18 | RESP-IMPL-004 | 1 | 04.parser-implementation.md | extractErrorMessageメソッドがあること | HIGH |
| 19 | RESP-IMPL-005 | 1 | 04.parser-implementation.md | code >= 400でerrors配列に分類されること | HIGH |
| 20 | RESP-PERF-001 | 1 | 04.parser-implementation.md | オプション未指定時は処理スキップされること | HIGH |
| 21 | RESP-PERF-002 | 1 | 04.parser-implementation.md | 型情報キャッシュが実装されていること | MEDIUM |
| 22 | RESP-YAML-001 | 1 | 05.yaml-output.md | buildYamlResponsesメソッドがあること | HIGH |
| 23 | RESP-YAML-002 | 1 | 05.yaml-output.md | 空レスポンスが省略されること | MEDIUM |
| 24 | RESP-YAML-003 | 1 | 05.yaml-output.md | errorsが配列形式で出力されること | HIGH |
| 25 | RESP-CLI-001 | 1 | 05.yaml-output.md | --extract-responsesオプションが認識されること | HIGH |
| 26 | RESP-CLI-002 | 1 | 05.yaml-output.md | --response-depthオプションが認識されること | MEDIUM |
| 27 | RESP-VAR-001 | 2 | 04.parser-implementation.md | resolveVariableValueが実装されていること | HIGH |
| 28 | RESP-VAR-002 | 2 | 04.parser-implementation.md | resolveVariableTypeが実装されていること | HIGH |
| 29 | RESP-DEEP-001 | 3 | 04.parser-implementation.md | analyzeExternalFunctionが実装されていること | HIGH |
| 30 | RESP-DEEP-002 | 3 | 04.parser-implementation.md | 再帰深度制限が機能すること | HIGH |
| 31 | RESP-CLI-003 | 3 | 05.yaml-output.md | --deep-analysisオプションが認識されること | HIGH |

---

## 観点詳細

### RESP-MODEL-001: ResponseInfo型にcodeフィールドがあること

**対象設計書**: [02.models.md](./02.models.md#responseinfo型)
**Phase**: 1
**重要度**: HIGH（必須）
**担当ファイル**: `src/types/response.ts`

#### 何をチェックするか

ResponseInfo型にcode: numberフィールドが存在することを確認する。

#### なぜ必要か

- HTTPステータスコードを格納するため
- 成功/エラーの分類に使用するため

#### 期待される状態

```typescript
export type ResponseInfo = {
  readonly code: number;  // <-- これが存在すること
  readonly dataType: readonly ParamInfo[];
  // ...
};
```

#### チェック手順

1. `src/types/response.ts`を読み込む
2. ResponseInfo型の定義を探す
3. `code: number`フィールドが存在することを確認
4. readonlyが付いていることを確認

#### NGパターン

```typescript
// NG: codeフィールドがない
export type ResponseInfo = {
  readonly dataType: readonly ParamInfo[];
};

// NG: 型が異なる
export type ResponseInfo = {
  readonly code: string;  // numberであるべき
};
```

---

### RESP-MODEL-006: EndpointInfo型にresponses?フィールドがあること

**対象設計書**: [02.models.md](./02.models.md#endpointinfo型拡張)
**重要度**: HIGH（必須）
**担当ファイル**: `src/types/endpoint.ts`

#### 何をチェックするか

EndpointInfo型にオプショナルなresponsesフィールドが追加されていることを確認する。

#### なぜ必要か

- extractResponsesオプション未使用時はundefined
- 後方互換性の維持

#### 期待される状態

```typescript
export type EndpointInfo = {
  // 既存フィールド...
  readonly responses?: EndpointResponses;  // <-- オプショナルで追加
};
```

#### チェック手順

1. `src/types/endpoint.ts`を読み込む
2. EndpointInfo型を確認
3. `responses?`がオプショナルフィールドとして存在することを確認
4. 型がEndpointResponsesであることを確認

#### NGパターン

```typescript
// NG: responsesがない
export type EndpointInfo = {
  readonly path: string;
  // responsesが欠落
};

// NG: 必須フィールドになっている
export type EndpointInfo = {
  readonly responses: EndpointResponses;  // ?がない
};
```

---

### RESP-IMPL-005: code >= 400でerrors配列に分類されること

**対象設計書**: [04.parser-implementation.md](./04.parser-implementation.md#extractreplysendcalls)
**Phase**: 1
**重要度**: HIGH（必須）
**担当ファイル**: `src/extractors/fastify/responseExtractor.ts`

#### 何をチェックするか

extractReplySendCallsメソッドで、ステータスコードが400以上の場合にerrors配列に分類されることを確認する。

#### なぜ必要か

- HTTP仕様に従った分類
- 4xx/5xxはエラーレスポンス

#### 期待される状態

```typescript
if (code >= 400) {
  // エラーレスポンスとして処理
  const message = this.extractErrorMessage(dataType);
  errorResponses.push({
    code,
    message,
    // ...
  });
} else {
  // 成功レスポンスとして処理
  successResponses.push({
    code,
    dataType,
    source: 'reply.code',
    // ...
  });
}
```

#### チェック手順

1. `src/extractors/fastify/responseExtractor.ts`を読み込む
2. extractReplySendCallsメソッドを確認
3. `code >= 400`の条件分岐があることを確認
4. 条件が真の場合はerrorResponses.push()していることを確認

#### NGパターン

```typescript
// NG: 400未満もエラーに分類
if (code >= 300) {  // 3xxはリダイレクト、エラーではない
  errorResponses.push(...);
}

// NG: 分類ロジックがない
successResponses.push(sendInfo);  // 常に成功扱い
```

---

### RESP-TEST-005: エラーメッセージ抽出テストがあること

**対象設計書**: [03.tests.md](./03.tests.md#エラーメッセージ抽出)
**Phase**: 1
**重要度**: HIGH（必須）
**担当ファイル**: `src/__tests__/responseExtractor.test.ts`

#### 何をチェックするか

エラーレスポンスからmessageプロパティを正しく抽出するテストが存在することを確認する。

#### なぜ必要か

- エラーメッセージ抽出ロジックの正確性を保証
- リテラル文字列の取得を検証

#### 期待される状態

```typescript
describe('エラーメッセージ抽出', () => {
  test('リテラル文字列のmessageを抽出する', () => {
    const extractor = createExtractor(ERROR_RESPONSE_FIXTURE);
    const responses = extractor.extractFromHandler(/* handler node */);

    expect(responses.errors[0].message).toBe('User not found');
  });

  test('messageプロパティがない場合は型名を返す', () => {
    // { error: 'FAIL' } のようなケース
    // message が 'string' になる
  });
});
```

#### チェック手順

1. `src/__tests__/responseExtractor.test.ts`を読み込む
2. `describe('エラーメッセージ抽出'`ブロックを探す
3. リテラル文字列抽出のテストがあることを確認
4. messageプロパティなしのケースのテストがあることを確認

#### NGパターン

```typescript
// NG: テストがない
// NG: message抽出の検証がない
test('エラーレスポンス', () => {
  expect(responses.errors[0].code).toBe(404);
  // messageの検証がない
});
```

---

### RESP-CLI-001: --extract-responsesオプションが認識されること

**対象設計書**: [05.yaml-output.md](./05.yaml-output.md#cliオプション追加)
**重要度**: HIGH（必須）
**担当ファイル**: `index.ts`

#### 何をチェックするか

CLIの引数パーサーが--extract-responsesオプションを認識してオプションに反映することを確認する。

#### なぜ必要か

- ユーザーがレスポンス抽出を有効化できるようにするため
- デフォルトはfalseで後方互換性維持

#### 期待される状態

```typescript
case '--extract-responses':
  options.extractResponses = true;
  break;
```

#### チェック手順

1. `index.ts`を読み込む
2. parseArgs関数を探す
3. `case '--extract-responses'`があることを確認
4. `options.extractResponses = true`が設定されていることを確認

#### NGパターン

```typescript
// NG: オプションがない
// switch文に--extract-responsesがない

// NG: 値の設定が間違っている
case '--extract-responses':
  options.extractResponse = true;  // 's'がない
```

---

## 設計書別チェックサマリー

### 02.models.md 関連

| 観点ID | 内容 | 完了条件 |
|--------|------|---------|
| RESP-MODEL-001 | ResponseInfo.code | number型で存在 |
| RESP-MODEL-002 | ResponseInfo.dataType | ParamInfo[]型で存在 |
| RESP-MODEL-003 | ResponseInfo.source | ResponseSource型で存在 |
| RESP-MODEL-004 | ErrorResponseInfo.errorId | string型で存在 |
| RESP-MODEL-005 | ErrorResponseInfo.messageType | string型で存在 |
| RESP-MODEL-006 | EndpointInfo.responses? | オプショナルで存在 |
| RESP-MODEL-007 | ExtractorOptions.extractResponses | boolean型で存在 |
| RESP-MODEL-008 | YamlEndpoint.responses? | オプショナルで存在 |

### 03.tests.md 関連

| 観点ID | 内容 | 完了条件 |
|--------|------|---------|
| RESP-TEST-001 | return文抽出テスト | テストケース存在 |
| RESP-TEST-002 | reply.send()抽出テスト | テストケース存在 |
| RESP-TEST-003 | reply.code().send()抽出テスト | テストケース存在 |
| RESP-TEST-004 | エラー分類テスト | テストケース存在 |
| RESP-TEST-005 | errorId推定テスト | 各コードのテスト存在 |

### 04.parser-implementation.md 関連

| 観点ID | 内容 | 完了条件 |
|--------|------|---------|
| RESP-IMPL-001 | ResponseExtractorクラス | クラス定義存在 |
| RESP-IMPL-002 | extractFromHandler | メソッド存在 |
| RESP-IMPL-003 | parseSendCall | メソッド存在 |
| RESP-IMPL-004 | inferErrorId | 静的メソッド存在 |
| RESP-IMPL-005 | エラー分類 | code >= 400で分類 |

### 05.yaml-output.md 関連

| 観点ID | 内容 | 完了条件 |
|--------|------|---------|
| RESP-YAML-001 | buildYamlResponses | メソッド存在 |
| RESP-YAML-002 | 空レスポンス省略 | null返却ロジック |
| RESP-CLI-001 | --extract-responses | オプション認識 |
| RESP-CLI-002 | --response-depth | オプション認識 |

---

## レビュー実行手順

1. このファイルを読み込む
2. 「レビュー観点一覧」の各観点について順番にチェック
3. 「観点詳細」セクションで詳細なチェック手順を確認
4. 各観点について PASS/FAIL を判定
5. FAILの場合は「NGパターン」と照合して問題を特定
6. レビュー結果を出力

---

## レビュー結果フォーマット

```markdown
# レビュー結果: レスポンス型抽出機能

実施日時: YYYY/MM/DD HH:mm

## サマリー

- PASS: X件
- FAIL: Y件
- SKIP: Z件

## 詳細

### PASS

| 観点ID | 内容 | 確認ファイル |
|--------|------|-------------|
| RESP-MODEL-001 | ResponseInfo.code存在 | src/types/response.ts:10 |

### FAIL

| 観点ID | 内容 | 問題 | 修正指示 |
|--------|------|------|---------|
| RESP-TEST-005 | errorId推定テスト | 500のテストがない | 03.tests.mdに従い追加 |

### 修正依頼

以下の修正を実施してください:

1. RESP-TEST-005: `src/__tests__/responseExtractor.test.ts`に500のテスト追加
   - 参照: 03.tests.md#errorid推定
```
