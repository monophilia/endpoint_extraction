# テスト設計

Updated: 2025/12/30 06:15

## 目的

ResponseExtractorのテストケースを設計する。TDD原則に従い、実装前にテストを作成する。

---

## テストファイル構成

```
src/__tests__/
├── responseExtractor.test.ts    # ResponseExtractor単体テスト
└── fixtures/
    └── response.fixture.ts      # テスト用フィクスチャ
```

---

## フィクスチャ設計

### response.fixture.ts

```typescript
// src/__tests__/fixtures/response.fixture.ts

export const SIMPLE_RETURN_FIXTURE = `
import { FastifyInstance } from 'fastify';

export default async function(server: FastifyInstance) {
  server.get('/users', async (req, reply) => {
    return { users: [], total: 0 };
  });
}
`;

export const REPLY_SEND_FIXTURE = `
import { FastifyInstance } from 'fastify';

export default async function(server: FastifyInstance) {
  server.get('/user/:id', async (req, reply) => {
    const user = { id: '1', name: 'Test' };
    reply.send(user);
  });
}
`;

export const REPLY_CODE_SEND_FIXTURE = `
import { FastifyInstance } from 'fastify';

export default async function(server: FastifyInstance) {
  server.post('/users', async (req, reply) => {
    const user = { id: '1', name: req.body.name };
    reply.code(201).send(user);
  });
}
`;

export const ERROR_RESPONSE_FIXTURE = `
import { FastifyInstance } from 'fastify';

export default async function(server: FastifyInstance) {
  server.get('/user/:id', async (req, reply) => {
    const user = findUser(req.params.id);
    if (!user) {
      reply.code(404).send({ error: 'NOT_FOUND', message: 'User not found' });
      return;
    }
    return user;
  });
}
`;

export const MULTIPLE_ERRORS_FIXTURE = `
import { FastifyInstance } from 'fastify';

export default async function(server: FastifyInstance) {
  server.post('/login', async (req, reply) => {
    const { email, password } = req.body;

    const user = await findUserByEmail(email);
    if (!user) {
      reply.code(404).send({ error: 'USER_NOT_FOUND', message: 'User not found' });
      return;
    }

    if (!verifyPassword(password, user.passwordHash)) {
      reply.code(401).send({ error: 'INVALID_PASSWORD', message: 'Invalid password' });
      return;
    }

    reply.code(200).send({ token: 'xxx', user });
  });
}
`;

export const GENERIC_REPLY_FIXTURE = `
import { FastifyInstance } from 'fastify';

type UserResponse = { id: string; name: string };
type ErrorResponse = { error: string; message: string };

export default async function(server: FastifyInstance) {
  server.get<{
    Params: { id: string };
    Reply: UserResponse | ErrorResponse;
  }>('/user/:id', async (req, reply) => {
    // ...
  });
}
`;

export const NO_RESPONSE_FIXTURE = `
import { FastifyInstance } from 'fastify';

export default async function(server: FastifyInstance) {
  server.delete('/user/:id', async (req, reply) => {
    await deleteUser(req.params.id);
    reply.code(204).send();
  });
}
`;
```

---

## テストケース設計

### ResponseExtractor単体テスト

```typescript
// src/__tests__/responseExtractor.test.ts

import { describe, test, expect } from 'bun:test';
import { Project } from 'ts-morph';
import { ResponseExtractor } from '../extractors/fastify/responseExtractor';
import {
  SIMPLE_RETURN_FIXTURE,
  REPLY_SEND_FIXTURE,
  REPLY_CODE_SEND_FIXTURE,
  ERROR_RESPONSE_FIXTURE,
  MULTIPLE_ERRORS_FIXTURE,
  GENERIC_REPLY_FIXTURE,
  NO_RESPONSE_FIXTURE,
} from './fixtures/response.fixture';

describe('ResponseExtractor', () => {
  // ヘルパー関数
  const createExtractor = (code: string) => {
    const project = new Project({ useInMemoryFileSystem: true });
    const sourceFile = project.createSourceFile('test.ts', code);
    return new ResponseExtractor(sourceFile);
  };

  describe('return文からの抽出', () => {
    test('シンプルなreturn文から成功レスポンスを抽出する', () => {
      const extractor = createExtractor(SIMPLE_RETURN_FIXTURE);
      // ハンドラー関数を取得してextract呼び出し
      const responses = extractor.extractFromHandler(/* handler node */);

      expect(responses.success).toHaveLength(1);
      expect(responses.success[0].code).toBe(200);
      expect(responses.success[0].source).toBe('return');
      expect(responses.success[0].dataType).toContainEqual(
        expect.objectContaining({ name: 'users' })
      );
      expect(responses.success[0].dataType).toContainEqual(
        expect.objectContaining({ name: 'total' })
      );
    });
  });

  describe('reply.send()からの抽出', () => {
    test('reply.send()から成功レスポンスを抽出する', () => {
      const extractor = createExtractor(REPLY_SEND_FIXTURE);
      const responses = extractor.extractFromHandler(/* handler node */);

      expect(responses.success).toHaveLength(1);
      expect(responses.success[0].code).toBe(200);
      expect(responses.success[0].source).toBe('reply.send');
    });
  });

  describe('reply.code().send()からの抽出', () => {
    test('reply.code(201).send()から成功レスポンスを抽出する', () => {
      const extractor = createExtractor(REPLY_CODE_SEND_FIXTURE);
      const responses = extractor.extractFromHandler(/* handler node */);

      expect(responses.success).toHaveLength(1);
      expect(responses.success[0].code).toBe(201);
      expect(responses.success[0].source).toBe('reply.code');
    });

    test('reply.code(404).send()からエラーレスポンスを抽出する', () => {
      const extractor = createExtractor(ERROR_RESPONSE_FIXTURE);
      const responses = extractor.extractFromHandler(/* handler node */);

      expect(responses.errors).toHaveLength(1);
      expect(responses.errors[0].code).toBe(404);
      expect(responses.errors[0].message).toBe('User not found');
    });
  });

  describe('複数エラーパターン', () => {
    test('複数のエラーレスポンスを抽出する', () => {
      const extractor = createExtractor(MULTIPLE_ERRORS_FIXTURE);
      const responses = extractor.extractFromHandler(/* handler node */);

      expect(responses.success).toHaveLength(1);
      expect(responses.success[0].code).toBe(200);

      expect(responses.errors).toHaveLength(2);
      expect(responses.errors.map(e => e.code)).toContain(404);
      expect(responses.errors.map(e => e.code)).toContain(401);
    });

    test('messageプロパティからエラーメッセージを抽出する', () => {
      const extractor = createExtractor(MULTIPLE_ERRORS_FIXTURE);
      const responses = extractor.extractFromHandler(/* handler node */);

      const notFoundError = responses.errors.find(e => e.code === 404);
      expect(notFoundError?.message).toBe('User not found');

      const authError = responses.errors.find(e => e.code === 401);
      expect(authError?.message).toBe('Invalid password');
    });
  });

  describe('ジェネリック型Replyからの抽出', () => {
    test('Reply型定義から成功レスポンスを抽出する', () => {
      const extractor = createExtractor(GENERIC_REPLY_FIXTURE);
      const responses = extractor.extractFromGenericType(/* call expression */);

      expect(responses?.success).toHaveLength(1);
      expect(responses?.success[0].source).toBe('generic');
      expect(responses?.success[0].typeName).toBe('UserResponse');
    });

    test('Reply型のユニオンからエラーレスポンスを抽出する', () => {
      const extractor = createExtractor(GENERIC_REPLY_FIXTURE);
      const responses = extractor.extractFromGenericType(/* call expression */);

      // ErrorResponseがerrors配列に分類される
      expect(responses?.errors.length).toBeGreaterThanOrEqual(0);
    });
  });

  describe('エッジケース', () => {
    test('レスポンスなし（204 No Content）', () => {
      const extractor = createExtractor(NO_RESPONSE_FIXTURE);
      const responses = extractor.extractFromHandler(/* handler node */);

      expect(responses.success).toHaveLength(1);
      expect(responses.success[0].code).toBe(204);
      expect(responses.success[0].dataType).toHaveLength(0);
    });

    test('ステータスコードによるエラー分類', () => {
      // 400-499: クライアントエラー
      // 500-599: サーバーエラー
      // どちらもerrors配列に分類される
    });
  });

  describe('エラーメッセージ抽出', () => {
    test('リテラル文字列のmessageを抽出する', () => {
      const extractor = createExtractor(ERROR_RESPONSE_FIXTURE);
      const responses = extractor.extractFromHandler(/* handler node */);

      expect(responses.errors[0].message).toBe('User not found');
    });

    test('messageプロパティがない場合は型名を返す', () => {
      // { error: 'FAIL' } のようなケース
      // message が 'string' になる
    });
  });
});
```

---

## テスト観点サマリー

### 正常系

| # | テストケース | 期待結果 |
|---|-------------|---------|
| 1 | return文からの抽出 | code: 200, source: 'return' |
| 2 | reply.send()からの抽出 | code: 200, source: 'reply.send' |
| 3 | reply.code(201).send() | code: 201, source: 'reply.code' |
| 4 | reply.code(404).send() | errors配列に分類、message抽出 |
| 5 | 複数エラーパターン | errors配列に複数 |
| 6 | ジェネリック型Reply | source: 'generic', typeName設定 |
| 7 | 204 No Content | dataType: [] |

### エラーメッセージ抽出

| # | テストケース | 期待結果 |
|---|-------------|---------|
| 1 | リテラル文字列message | 文字列値を抽出 |
| 2 | messageプロパティなし | 'string'を返す |

### 異常系・境界（Phase 2/3で対応）

| # | テストケース | Phase | 期待結果 |
|---|-------------|-------|---------|
| 1 | 動的ステータスコード | 2 | 変数追跡で抽出 |
| 2 | 変数経由のレスポンス | 2 | 変数追跡で抽出 |
| 3 | 外部関数でのレスポンス | 3 | 関数追跡で抽出 |

---

## 完了条件

- [ ] 全テストファイルが作成されている
- [ ] 全テストケースが実装されている
- [ ] テストが実行可能（FAILするのが正常）
- [ ] フィクスチャが設計通りに定義されている
