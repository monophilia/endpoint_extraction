# レスポンス型抽出機能

Updated: 2025/12/30 06:15

## 概要

Fastifyエンドポイントからレスポンス型を抽出し、ステータスコード別に分類してYAML出力に含める機能の設計。

### 背景

現在の実装（fastify-endpoint-extractor）では入力パラメータ（pathParams, queryParams, bodyParams）のみを抽出しているが、API仕様として出力（レスポンス）の型情報も重要である。

### 課題

1. レスポンスはステータスコードによって異なる型を持つ
2. 成功レスポンスとエラーレスポンスで構造が異なる
3. 抽出対象が増えるためパフォーマンスへの影響がある

## 目次

1. [タスクリスト](./01.tasks.md) - コンテキスト復旧用
2. [モデル/データ型設計](./02.models.md) - 型定義
3. [テスト設計](./03.tests.md) - テストケース
4. [実装設計](./04.parser-implementation.md) - ResponseExtractor実装
5. [YAML出力設計](./05.yaml-output.md) - レスポンス出力フォーマット
99. [レビューチェックリスト](./99.review-checklist.md) - 品質保証用レビュー観点

## スコープ

### 対象

- Fastifyのreturn文からのレスポンス抽出
- reply.send()からのレスポンス抽出
- reply.code(xxx).send()からのステータスコード別レスポンス抽出
- ジェネリック型Reply定義からの抽出
- エラーレスポンスの分類（4xx/5xx）
- YAML出力へのresponsesセクション追加
- CLIオプション（--extract-responses）追加

## 前提条件

- fastify-endpoint-extractorが動作していること（26テストパス）
- ts-morphライブラリが利用可能

## 依存関係

| パッケージ | バージョン | 用途 |
|-----------|-----------|------|
| ts-morph | ^23.0.0 | TypeScript AST解析（既存） |

## 実装フェーズ

### Phase 1: 基本実装

| Step | 内容 | 担当設計書 |
|------|------|-----------|
| 1 | ResponseInfo型定義 | 02.models.md |
| 2 | テスト作成 | 03.tests.md |
| 3 | ResponseExtractor実装 | 04.parser-implementation.md |
| 4 | RouteFileParser統合 | 04.parser-implementation.md |
| 5 | YamlGenerator拡張 | 05.yaml-output.md |
| 6 | CLIオプション追加 | 05.yaml-output.md |

対象パターン:
- return文からのレスポンス
- reply.send()
- reply.code(xxx).send()
- ジェネリック型Reply

### Phase 2: 変数追跡

| パターン | 計算量 | 実装方針 |
|---------|--------|---------|
| 動的なステータスコード（変数経由） | O(n) | 変数定義の逆参照 |
| 変数経由のレスポンスオブジェクト | O(n) | 代入チェーン追跡 |

CLIオプション: `--extract-responses`と併用で有効

### Phase 3: 高度な解析

| パターン | 計算量 | 実装方針 |
|---------|--------|---------|
| 外部関数内でのレスポンス処理 | O(n*m) | 関数定義解決、ファイル横断解析 |
| 複雑な条件分岐のステータスコード推定 | O(2^n) | 制御フロー解析 |

CLIオプション: `--deep-analysis`で有効（パフォーマンス影響大のため明示的に有効化）

## パフォーマンス設計

### 基本方針

現状の軽量な動作を維持するため、以下の最適化を必須とする。

### 最適化手法

| 手法 | 説明 | 効果 |
|------|------|------|
| オプション分岐 | `--extract-responses`未指定時は一切処理しない | 後方互換性、ゼロコスト |
| 単一パス処理 | ハンドラーを1回のトラバースで全情報抽出 | O(n)維持 |
| 早期終了 | 必要な情報が見つかったら即座にreturn | 不要な走査回避 |
| ノードフィルタリング | SyntaxKindで不要ノードを即座にスキップ | 分岐コスト削減 |
| 型情報キャッシュ | 同一ノードの型解析結果を再利用 | 重複解析回避 |
| 参照のみ保持 | ASTノードをコピーせず参照で扱う | メモリ効率 |

### Phase別パフォーマンス制御

| Phase | デフォルト | 有効化オプション | 理由 |
|-------|-----------|-----------------|------|
| Phase 1 | OFF | `--extract-responses` | 基本機能、低コスト |
| Phase 2 | ON | Phase 1有効時に自動 | O(n)で許容範囲 |
| Phase 3 | OFF | `--deep-analysis` | O(n*m)以上、明示的有効化必須 |

## 親設計書との関係

本設計書は `docs/fastify-endpoint-extractor/` の拡張機能として位置付けられる。

- 既存の型定義を拡張（EndpointInfo, YamlEndpoint, ExtractorOptions）
- 既存のパーサーに統合（RouteFileParser）
- 既存のジェネレーターを拡張（YamlGenerator）

## 入出力例

### 入力（ルートファイル）

```typescript
server.post('/login', async (req, reply) => {
  const { email, password } = req.body;

  const user = await findUserByEmail(email);
  if (!user) {
    reply.code(404).send({ error: 'USER_NOT_FOUND', message: 'User not found' });
    return;
  }

  if (!verifyPassword(password, user.passwordHash)) {
    reply.code(401).send({ error: 'INVALID_PASSWORD', message: 'Invalid password' });
    return;
  }

  reply.code(200).send({ token: generateToken(user), user });
});
```

### 出力（YAML）

```yaml
/auth:
  /login:
    METHOD: POST
    bodyParams:
      email: string
      password: string
    requiresAuth: false
    responses:
      success:
        code: 200
        dataType:
          token: string
          user: object
      errors:
        - code: 404
          message: "User not found"
        - code: 401
          message: "Invalid password"
```
