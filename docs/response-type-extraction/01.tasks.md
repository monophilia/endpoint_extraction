# タスクリスト: レスポンス型抽出機能

Updated: 2025/12/30 14:15

## 復旧手順

このファイルを読み込んだ場合、以下を実行:
1. 下記のTodo一覧をTodoWriteで設定
2. in_progressのタスクから作業再開
3. 該当タスクの詳細セクションを参照

---

## 進捗サマリー

- **Phase 1**: 完了 (タスク1-10 全てcompleted)
- **Phase 2**: 未着手 (タスク11-13)
- **Phase 3**: 未着手 (タスク14-16)
- **ブランチ**: `feature/response-type-extraction`
- **レビュー結果**: 全19観点PASS

---

## Todo一覧（TodoWrite用）

<!-- TodoWrite形式: content | status | activeForm -->
| # | タスク | Phase | 状態 | 進行形 |
|---|--------|-------|------|--------|
| 1 | ResponseInfo型を定義する | 1 | completed | ResponseInfo型を定義している |
| 2 | ErrorResponseInfo型を定義する | 1 | completed | ErrorResponseInfo型を定義している |
| 3 | EndpointInfo型にresponsesを追加する | 1 | completed | EndpointInfo型を拡張している |
| 4 | ExtractorOptions型を拡張する | 1 | completed | ExtractorOptions型を拡張している |
| 5 | YAML出力型を拡張する | 1 | completed | YAML出力型を拡張している |
| 6 | ResponseExtractor用テストを作成する（Phase 1） | 1 | completed | ResponseExtractorテストを作成している |
| 7 | ResponseExtractorを実装する（Phase 1） | 1 | completed | ResponseExtractorを実装している |
| 8 | RouteFileParserにResponseExtractorを統合する | 1 | completed | ResponseExtractorを統合している |
| 9 | YamlGeneratorにレスポンス出力を追加する | 1 | completed | レスポンス出力を追加している |
| 10 | CLIに--extract-responsesオプションを追加する | 1 | completed | CLIオプションを追加している |
| 11 | 変数追跡用テストを作成する | 2 | pending | 変数追跡テストを作成している |
| 12 | resolveVariableValueを実装する | 2 | pending | 変数値解決を実装している |
| 13 | resolveVariableTypeを実装する | 2 | pending | 変数型解決を実装している |
| 14 | 高度な解析用テストを作成する | 3 | pending | 高度な解析テストを作成している |
| 15 | analyzeExternalFunctionを実装する | 3 | pending | 外部関数解析を実装している |
| 16 | CLIに--deep-analysisオプションを追加する | 3 | pending | --deep-analysisを追加している |

---

## タスク詳細

### タスク1: ResponseInfo型を定義する

**状態**: pending
**参照設計書**: [02.models.md](./02.models.md#responseinfo型)

**作業内容**:
1. `src/types/response.ts` を新規作成
2. ResponseSource型を定義
3. ResponseInfo型を定義

**担当ファイル**:
- `src/types/response.ts`（新規）

**完了条件**:
- [ ] ResponseSource型が定義されている
- [ ] ResponseInfo型が設計書と一致
- [ ] readonly修飾子が付いている

---

### タスク2: ErrorResponseInfo型を定義する

**状態**: pending
**参照設計書**: [02.models.md](./02.models.md#errorresponseinfo型)

**作業内容**:
1. `src/types/response.ts` にErrorResponseInfo型を追加
2. EndpointResponses型を追加

**担当ファイル**:
- `src/types/response.ts`

**完了条件**:
- [ ] ErrorResponseInfo型が設計書と一致
- [ ] EndpointResponses型が定義されている

---

### タスク3: EndpointInfo型にresponsesを追加する

**状態**: pending
**参照設計書**: [02.models.md](./02.models.md#endpointinfo型拡張)

**作業内容**:
1. `src/types/endpoint.ts` にEndpointResponses型をインポート
2. EndpointInfo型にresponses?フィールドを追加

**担当ファイル**:
- `src/types/endpoint.ts`

**完了条件**:
- [ ] responses?がオプショナルフィールドとして追加されている
- [ ] 型がEndpointResponses

---

### タスク4: ExtractorOptions型を拡張する

**状態**: pending
**参照設計書**: [02.models.md](./02.models.md#extractoroptions型拡張)

**作業内容**:
1. `src/types/options.ts` にextractResponsesを追加
2. responseDepthLimitを追加
3. CLIOptions型も同様に拡張

**担当ファイル**:
- `src/types/options.ts`

**完了条件**:
- [ ] extractResponses?: boolean が追加されている
- [ ] responseDepthLimit?: number が追加されている
- [ ] CLIOptionsにも同様のフィールドがある

---

### タスク5: YAML出力型を拡張する

**状態**: pending
**参照設計書**: [02.models.md](./02.models.md#yaml出力型拡張)

**作業内容**:
1. `src/types/yaml.ts` にYamlSuccessResponse型を追加
2. YamlErrorResponse型を追加
3. YamlResponses型を追加
4. YamlEndpoint型にresponses?を追加
5. `src/types/index.ts` にエクスポートを追加

**担当ファイル**:
- `src/types/yaml.ts`
- `src/types/index.ts`

**完了条件**:
- [ ] 全YAML型が設計書と一致
- [ ] index.tsからエクスポートされている

---

### タスク6: ResponseExtractor用テストを作成する

**状態**: pending
**参照設計書**: [03.tests.md](./03.tests.md)

**作業内容**:
1. `src/__tests__/fixtures/response.fixture.ts` を作成
2. `src/__tests__/responseExtractor.test.ts` を作成
3. 全テストケースを実装

**担当ファイル**:
- `src/__tests__/fixtures/response.fixture.ts`（新規）
- `src/__tests__/responseExtractor.test.ts`（新規）

**完了条件**:
- [ ] 全フィクスチャが定義されている
- [ ] 全テストケースが実装されている
- [ ] テストが実行可能（FAILするのが正常）

---

### タスク7: ResponseExtractorを実装する

**状態**: pending
**参照設計書**: [04.parser-implementation.md](./04.parser-implementation.md)

**作業内容**:
1. `src/extractors/fastify/responseExtractor.ts` を作成
2. extractFromHandlerメソッドを実装
3. extractFromGenericTypeメソッドを実装
4. inferErrorIdメソッドを実装
5. parseSendCallメソッドを実装

**担当ファイル**:
- `src/extractors/fastify/responseExtractor.ts`（新規）

**完了条件**:
- [ ] タスク6のテストが全てパスする
- [ ] TypeScriptエラーがない

---

### タスク8: RouteFileParserにResponseExtractorを統合する

**状態**: pending
**参照設計書**: [04.parser-implementation.md](./04.parser-implementation.md#routefileparser統合)

**作業内容**:
1. RouteFileParserにResponseExtractorをインポート
2. extractResponsesオプションのチェック追加
3. ハンドラー関数取得ロジック追加
4. レスポンス抽出呼び出し
5. EndpointInfoにresponsesを追加

**担当ファイル**:
- `src/extractors/fastify/routeFileParser.ts`

**完了条件**:
- [ ] extractResponsesがtrueの場合のみ抽出
- [ ] responsesがEndpointInfoに含まれる
- [ ] 既存テストがパスする

---

### タスク9: YamlGeneratorにレスポンス出力を追加する

**状態**: pending
**参照設計書**: [05.yaml-output.md](./05.yaml-output.md)

**作業内容**:
1. buildYamlResponsesメソッドを追加
2. buildYamlEndpointでレスポンス出力を追加
3. 空のレスポンスは出力しない条件追加

**担当ファイル**:
- `src/generators/yamlGenerator.ts`

**完了条件**:
- [ ] responsesセクションがYAMLに出力される
- [ ] 空の場合は省略される

---

### タスク10: CLIに--extract-responsesオプションを追加する

**状態**: pending
**参照設計書**: [05.yaml-output.md](./05.yaml-output.md#cliオプション追加)

**作業内容**:
1. parseArgsに--extract-responsesを追加
2. --response-depthオプションを追加
3. printUsageにオプション説明を追加
4. ExtractorOptionsに値を渡す

**担当ファイル**:
- `index.ts`

**完了条件**:
- [ ] --extract-responsesが認識される
- [ ] --response-depthが認識される
- [ ] ヘルプに表示される

---

---

### タスク11: 変数追跡用テストを作成する

**状態**: pending
**Phase**: 2
**参照設計書**: [04.parser-implementation.md](./04.parser-implementation.md#phase-2-変数追跡)

**作業内容**:
1. 動的ステータスコードのテストケース追加
2. 変数経由レスポンスのテストケース追加

**担当ファイル**:
- `src/__tests__/responseExtractor.test.ts`
- `src/__tests__/fixtures/response.fixture.ts`

**完了条件**:
- [ ] 変数経由ステータスコードのテストがある
- [ ] 変数経由レスポンスのテストがある
- [ ] テストが実行可能（FAILするのが正常）

---

### タスク12: resolveVariableValueを実装する

**状態**: pending
**Phase**: 2
**参照設計書**: [04.parser-implementation.md](./04.parser-implementation.md#phase-2-変数追跡)

**作業内容**:
1. Identifier判定の追加
2. getDefinitionNodes()による定義取得
3. NumericLiteralの値抽出

**担当ファイル**:
- `src/extractors/fastify/responseExtractor.ts`

**完了条件**:
- [ ] 変数経由のステータスコードが解決できる
- [ ] タスク11のテストがパスする

---

### タスク13: resolveVariableTypeを実装する

**状態**: pending
**Phase**: 2
**参照設計書**: [04.parser-implementation.md](./04.parser-implementation.md#phase-2-変数追跡)

**作業内容**:
1. 変数定義のInitializerから型を取得
2. getCachedTypeによるキャッシュ活用

**担当ファイル**:
- `src/extractors/fastify/responseExtractor.ts`

**完了条件**:
- [ ] 変数経由のレスポンス型が解決できる
- [ ] タスク11のテストが全てパスする

---

### タスク14: 高度な解析用テストを作成する

**状態**: pending
**Phase**: 3
**参照設計書**: [04.parser-implementation.md](./04.parser-implementation.md#phase-3-高度な解析)

**作業内容**:
1. 外部関数呼び出しのテストケース追加
2. 複雑な条件分岐のテストケース追加

**担当ファイル**:
- `src/__tests__/responseExtractor.test.ts`
- `src/__tests__/fixtures/response.fixture.ts`

**完了条件**:
- [ ] 外部関数のテストがある
- [ ] 条件分岐のテストがある
- [ ] テストが実行可能（FAILするのが正常）

---

### タスク15: analyzeExternalFunctionを実装する

**状態**: pending
**Phase**: 3
**参照設計書**: [04.parser-implementation.md](./04.parser-implementation.md#phase-3-高度な解析)

**作業内容**:
1. resolveFunctionDefinitionの実装
2. 同一ファイル内関数の追跡
3. 再帰深度制限の実装

**担当ファイル**:
- `src/extractors/fastify/responseExtractor.ts`

**完了条件**:
- [ ] 同一ファイル内の関数呼び出しが追跡できる
- [ ] 再帰深度制限が機能する
- [ ] タスク14のテストがパスする

---

### タスク16: CLIに--deep-analysisオプションを追加する

**状態**: pending
**Phase**: 3
**参照設計書**: [04.parser-implementation.md](./04.parser-implementation.md#phase-3-高度な解析)

**作業内容**:
1. parseArgsに--deep-analysisを追加
2. --deep-analysis-depthオプションを追加
3. printUsageにオプション説明を追加
4. ExtractorOptionsに値を渡す

**担当ファイル**:
- `index.ts`

**完了条件**:
- [ ] --deep-analysisが認識される
- [ ] --deep-analysis-depthが認識される
- [ ] ヘルプに表示される

---

## 実装順序の依存関係

```
=== Phase 1: 基本実装 ===

タスク1-2 (ResponseInfo/ErrorResponseInfo型)
    │
    ▼
タスク3-5 (既存型の拡張) ─── 並列実行可能
    │
    ▼
タスク6 (Phase 1テスト作成)
    │
    ▼
タスク7 (ResponseExtractor Phase 1実装)
    │
    ▼
タスク8 (RouteFileParser統合)
    │
    ▼
タスク9 (YamlGenerator拡張)
    │
    ▼
タスク10 (--extract-responsesオプション)

=== Phase 2: 変数追跡 ===

タスク10完了
    │
    ▼
タスク11 (Phase 2テスト作成)
    │
    ▼
タスク12-13 (変数解決実装) ─── 並列実行可能

=== Phase 3: 高度な解析 ===

タスク13完了
    │
    ▼
タスク14 (Phase 3テスト作成)
    │
    ▼
タスク15 (外部関数解析実装)
    │
    ▼
タスク16 (--deep-analysisオプション)
```
