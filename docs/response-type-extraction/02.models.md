# モデル/データ型設計

Updated: 2025/12/30 06:15

## 目的

レスポンス型抽出機能に必要な型定義を設計する。

## 新規型定義

### ResponseSource型

レスポンスがどこから検出されたかを示す。

```typescript
// src/types/response.ts

export type ResponseSource = 'return' | 'reply.send' | 'reply.code' | 'generic';
```

### ResponseInfo型

単一レスポンスの情報。

```typescript
// src/types/response.ts

import type { ParamInfo } from './param';

export type ResponseInfo = {
  /** HTTPステータスコード */
  readonly code: number;
  /** レスポンスデータの型（プロパティ情報） */
  readonly dataType: readonly ParamInfo[];
  /** 型名（型エイリアスがある場合） */
  readonly typeName?: string;
  /** 検出ソース */
  readonly source: ResponseSource;
  /** ソースファイル内の行番号 */
  readonly lineNumber: number;
};
```

### ErrorResponseInfo型

エラーレスポンスの情報。

```typescript
// src/types/response.ts

export type ErrorResponseInfo = {
  /** HTTPステータスコード */
  readonly code: number;
  /** エラーメッセージ（リテラル文字列または型名） */
  readonly message: string;
  /** 追加データ型（あれば） */
  readonly dataType?: readonly ParamInfo[];
  /** 行番号 */
  readonly lineNumber: number;
};
```

**設計判断**: `errorId`は静的解析で意味のある名前を推定することが困難なため削除。代わりに`code`と`message`で識別する。

### EndpointResponses型

エンドポイントのレスポンス情報全体。

```typescript
// src/types/response.ts

export type EndpointResponses = {
  /** 成功レスポンス（通常1つ、まれに複数） */
  readonly success: readonly ResponseInfo[];
  /** エラーレスポンス */
  readonly errors: readonly ErrorResponseInfo[];
};
```

---

## 既存型の拡張

### EndpointInfo型（拡張）

```typescript
// src/types/endpoint.ts

export type EndpointInfo = {
  // 既存フィールド（変更なし）
  readonly path: string;
  readonly method: HttpMethod;
  readonly pathParams: readonly ParamInfo[];
  readonly queryParams: readonly ParamInfo[];
  readonly bodyParams: readonly ParamInfo[];
  readonly auth: AuthInfo;
  readonly sourceFile: string;
  readonly lineNumber: number;

  // 新規追加
  readonly responses?: EndpointResponses;
};
```

### ExtractorOptions型（拡張）

```typescript
// src/types/options.ts

export type ExtractorOptions = {
  // 既存フィールド（変更なし）
  readonly projectRoot: string;
  readonly entryFilePath?: string;
  readonly tsconfigPath?: string;
  readonly authConfig?: AuthConfig;
  readonly verbose?: boolean;

  // 新規追加（Phase 1）
  /** レスポンス型を抽出するか（デフォルト: false） */
  readonly extractResponses?: boolean;
  /** レスポンス抽出の深さ制限（デフォルト: 3） */
  readonly responseDepthLimit?: number;

  // 新規追加（Phase 3）
  /** 高度な解析を有効にするか（デフォルト: false） */
  readonly deepAnalysis?: boolean;
  /** 高度な解析の再帰深度制限（デフォルト: 3） */
  readonly deepAnalysisDepth?: number;
};
```

### CLIOptions型（拡張）

```typescript
// src/types/options.ts

export type CLIOptions = {
  // 既存フィールド（変更なし）
  readonly projectRoot: string;
  readonly framework?: FrameworkType;
  readonly outputPath?: string;
  readonly verbose?: boolean;
  readonly authConfig?: AuthConfig;

  // 新規追加（Phase 1）
  readonly extractResponses?: boolean;
  readonly responseDepthLimit?: number;

  // 新規追加（Phase 3）
  readonly deepAnalysis?: boolean;
  readonly deepAnalysisDepth?: number;
};
```

---

## YAML出力型（拡張）

### YamlSuccessResponse型

```typescript
// src/types/yaml.ts

export type YamlSuccessResponse = {
  readonly code: number;
  readonly dataType: YamlParams;
};
```

### YamlErrorResponse型

```typescript
// src/types/yaml.ts

export type YamlErrorResponse = {
  readonly code: number;
  readonly message: string;
};
```

### YamlResponses型

```typescript
// src/types/yaml.ts

export type YamlResponses = {
  readonly success?: YamlSuccessResponse;
  readonly errors?: readonly YamlErrorResponse[];  // 配列形式
};
```

### YamlEndpoint型（拡張）

```typescript
// src/types/yaml.ts

export type YamlEndpoint = {
  // 既存フィールド（変更なし）
  readonly METHOD: string;
  readonly pathParams?: YamlParams;
  readonly queryParams?: YamlParams;
  readonly bodyParams?: YamlParams;
  readonly requiresAuth: boolean;
  readonly authMiddlewares?: readonly string[];

  // 新規追加
  readonly responses?: YamlResponses;
};
```

---

## エクスポート

```typescript
// src/types/index.ts に追加

export type {
  ResponseInfo,
  ErrorResponseInfo,
  EndpointResponses,
  ResponseSource
} from './response';

export type {
  YamlSuccessResponse,
  YamlErrorResponse,
  YamlResponses
} from './yaml';
```

---

## 変更対象ファイル

| ファイル | 変更種別 | 内容 |
|----------|---------|------|
| `src/types/response.ts` | 新規 | ResponseInfo, ErrorResponseInfo, EndpointResponses, ResponseSource |
| `src/types/endpoint.ts` | 修正 | responses?フィールド追加 |
| `src/types/options.ts` | 修正 | extractResponses, responseDepthLimit追加 |
| `src/types/yaml.ts` | 修正 | YamlSuccessResponse, YamlErrorResponse, YamlResponses追加、YamlEndpoint拡張 |
| `src/types/index.ts` | 修正 | 新規型のエクスポート追加 |

## 型の関係図

```
EndpointInfo
    │
    └── responses?: EndpointResponses
                        │
                        ├── success: ResponseInfo[]
                        │       ├── code: number
                        │       ├── dataType: ParamInfo[]
                        │       ├── typeName?: string
                        │       ├── source: ResponseSource
                        │       └── lineNumber: number
                        │
                        └── errors: ErrorResponseInfo[]
                                ├── code: number
                                ├── message: string
                                ├── dataType?: ParamInfo[]
                                └── lineNumber: number
```
