# YAML出力設計

Updated: 2025/12/30 06:15

## 目的

レスポンス情報をYAML形式で出力するための設計。

---

## 出力フォーマット

### 成功レスポンスのみ

```yaml
/users:
  /:
    METHOD: GET
    requiresAuth: false
    responses:
      success:
        code: 200
        dataType:
          users: User[]
          total: number
```

### 成功 + エラーレスポンス

```yaml
/users:
  /:id:
    METHOD: GET
    pathParams:
      id: string
    requiresAuth: true
    responses:
      success:
        code: 200
        dataType:
          id: string
          name: string
          email: string
      errors:
        - code: 404
          message: "User not found"
        - code: 401
          message: "Authentication required"
```

### 複雑なエラーパターン

```yaml
/auth:
  /login:
    METHOD: POST
    bodyParams:
      email: string
      password: string
    requiresAuth: false
    responses:
      success:
        code: 200
        dataType:
          token: string
          user:
            id: string
            name: string
      errors:
        - code: 404
          message: "User not found"
        - code: 401
          message: "Invalid password"
        - code: 400
          message: "Email and password required"
```

### レスポンスなし（--extract-responsesオプション未指定時）

```yaml
/users:
  /:id:
    METHOD: GET
    pathParams:
      id: string
    requiresAuth: true
    # responsesセクションは出力されない
```

---

## YamlGenerator拡張

### buildYamlEndpoint変更

```typescript
// src/generators/yamlGenerator.ts

private buildYamlEndpoint(endpoint: EndpointInfo): YamlEndpoint {
  const result: Record<string, unknown> = {
    METHOD: endpoint.method,
  };

  // 既存のパラメータ出力...
  if (endpoint.pathParams.length > 0) {
    result.pathParams = this.buildYamlParams(endpoint.pathParams);
  }
  if (endpoint.queryParams.length > 0) {
    result.queryParams = this.buildYamlParams(endpoint.queryParams);
  }
  if (endpoint.bodyParams.length > 0) {
    result.bodyParams = this.buildYamlParams(endpoint.bodyParams);
  }

  // 認証情報
  result.requiresAuth = endpoint.auth.required;
  if (endpoint.auth.middlewares.length > 0) {
    result.authMiddlewares = endpoint.auth.middlewares;
  }

  // レスポンス情報（新規追加）
  if (endpoint.responses) {
    const responses = this.buildYamlResponses(endpoint.responses);
    if (responses) {
      result.responses = responses;
    }
  }

  return result as YamlEndpoint;
}

private buildYamlResponses(responses: EndpointResponses): YamlResponses | null {
  // 成功レスポンスもエラーレスポンスもない場合はnull
  if (responses.success.length === 0 && responses.errors.length === 0) {
    return null;
  }

  const result: Record<string, unknown> = {};

  // 成功レスポンス（最初の1つを使用）
  if (responses.success.length > 0) {
    const success = responses.success[0];
    result.success = {
      code: success.code,
      dataType: this.buildYamlParams(success.dataType),
    };
  }

  // エラーレスポンス（配列形式）
  if (responses.errors.length > 0) {
    result.errors = responses.errors.map(error => ({
      code: error.code,
      message: error.message,
    }));
  }

  return result as YamlResponses;
}
```

---

## CLIオプション追加

### parseArgs変更

```typescript
// index.ts

function parseArgs(args: string[]): CLIOptions {
  const options: Partial<CLIOptions> = {};
  let i = 0;

  while (i < args.length) {
    const arg = args[i];

    switch (arg) {
      // 既存オプション...

      case '--extract-responses':
        options.extractResponses = true;
        break;

      case '--response-depth':
        const depth = parseInt(args[++i], 10);
        if (Number.isNaN(depth) || depth < 1) {
          console.error('--response-depth requires a positive integer');
          process.exit(1);
        }
        options.responseDepthLimit = depth;
        break;

      // Phase 3: 高度な解析オプション
      case '--deep-analysis':
        options.deepAnalysis = true;
        break;

      case '--deep-analysis-depth':
        const analysisDepth = parseInt(args[++i], 10);
        if (Number.isNaN(analysisDepth) || analysisDepth < 1) {
          console.error('--deep-analysis-depth requires a positive integer');
          process.exit(1);
        }
        options.deepAnalysisDepth = analysisDepth;
        break;

      // ...
    }
    i++;
  }

  return options as CLIOptions;
}
```

### printUsage変更

```typescript
function printUsage(): void {
  console.log(`
Usage: endpoint-extractor <project-path> [options]

Options:
  --framework <name>          Framework (fastify, nestjs, express)
  --output <file>             Output file path
  --verbose                   Enable verbose logging
  --auth-middlewares <list>   Auth middleware names (comma-separated)
  --extract-responses         Extract response types (default: false)
  --response-depth <n>        Max depth for response extraction (default: 3)
  --deep-analysis             Enable deep analysis (external functions, etc.)
  --deep-analysis-depth <n>   Max recursion depth for deep analysis (default: 3)

Examples:
  endpoint-extractor /path/to/project
  endpoint-extractor /path/to/project --output endpoints.yaml
  endpoint-extractor /path/to/project --extract-responses
  endpoint-extractor /path/to/project --extract-responses --response-depth 2
  endpoint-extractor /path/to/project --extract-responses --deep-analysis
`);
}
```

---

## メタ情報拡張（オプション）

レスポンス抽出時、_metaに追加情報を含めることも検討:

```yaml
_meta:
  framework: fastify
  projectRoot: /path/to/project
  extractedAt: "2025-12-30T06:00:00.000Z"
  totalEndpoints: 15
  authRequiredCount: 10
  publicCount: 5
  # 新規追加
  responsesExtracted: true
  endpointsWithResponses: 12
```

---

## 変更対象ファイル

| ファイル | 変更種別 | 内容 |
|----------|---------|------|
| `src/generators/yamlGenerator.ts` | 修正 | buildYamlResponses追加 |
| `index.ts` | 修正 | --extract-responses, --response-depth追加 |

## 完了条件

### Phase 1

- [ ] responsesセクションがYAMLに出力される
- [ ] 空のレスポンスは出力されない
- [ ] --extract-responsesオプションが認識される
- [ ] --response-depthオプションが認識される
- [ ] ヘルプに新オプションが表示される

### Phase 3

- [ ] --deep-analysisオプションが認識される
- [ ] --deep-analysis-depthオプションが認識される
- [ ] ヘルプにPhase 3オプションが表示される
