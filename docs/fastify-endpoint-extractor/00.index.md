# Endpoint Extractor - AST解析ツール

Updated: 2025/12/29 23:12

## 概要

TypeScript ASTを使用してWebフレームワークプロジェクトのエンドポイント定義を解析し、
YAML形式で出力するコマンドラインツール。

**対応フレームワーク:**
- Fastify（初期実装）
- NestJS（将来拡張）
- Express（将来拡張）

### 目的

- Webフレームワークプロジェクトの全エンドポイントを自動で抽出
- APIドキュメント生成の基盤として活用
- エンドポイントの棚卸し・レビューに使用
- 認証要否の可視化

### ユースケース

1. 新規参加者がAPIの全体像を把握する
2. API仕様書の自動生成
3. フロントエンドとの型共有の基盤
4. セキュリティレビュー（認証漏れの検出）

## 目次

1. [タスクリスト](./01.tasks.md) - コンテキスト復旧用
2. [モデル/データ型設計](./02.models.md) - 型定義
3. [テスト設計](./03.tests.md) - テストケース
4. [パーサー実装設計](./04.parser-implementation.md) - AST解析ロジック
5. [YAML出力設計](./05.yaml-output.md) - 出力フォーマット
6. [Extractorアーキテクチャ](./06.extractor-architecture.md) - マルチフレームワーク対応設計
99. [レビューチェックリスト](./99.review-checklist.md) - 品質保証用レビュー観点

## スコープ

### 対象

- Fastifyのルート登録パターン（`app.register(Routes, { prefix })`）
- HTTPメソッド定義（`server.get/post/put/delete/patch`）
- ジェネリック型パラメータ（`Params`, `Querystring`, `Body`）
- 型リテラルおよび型参照の解析
- 認証ミドルウェアの検出（設定可能な識別子リスト）
- マルチフレームワーク対応のプラグインアーキテクチャ

### 対象外

- Socket.IOイベントハンドラ（将来拡張候補）
- レスポンス型の解析（将来拡張）
- 動的ルート生成パターン

## 前提条件

- Bun 1.0以上
- TypeScriptプロジェクト
- ts-morphライブラリ

## 依存関係

| パッケージ | バージョン | 用途 |
|-----------|-----------|------|
| ts-morph | ^23.0.0 | TypeScript AST解析 |
| yaml | ^2.3.0 | YAML出力 |

## 実装フェーズ

| Phase | 内容 | 担当設計書 |
|-------|------|-----------|
| 1 | コア型定義 | 02.models.md |
| 2 | Extractorインターフェース定義 | 02.models.md, 06.extractor-architecture.md |
| 3 | テスト作成 | 03.tests.md |
| 4 | Fastify Extractor実装 | 04.parser-implementation.md |
| 5 | 認証解析改善 | 04.parser-implementation.md |
| 6 | YAML出力 | 05.yaml-output.md |
| 7 | フレームワーク検出 | 06.extractor-architecture.md |
| 8 | NestJS Extractor実装（将来） | 06.extractor-architecture.md |

## 入出力例

### 入力

```bash
# 自動検出モード
bun run index.ts /path/to/project

# フレームワーク指定モード
bun run index.ts /path/to/project --framework fastify

# 認証ミドルウェア指定
bun run index.ts /path/to/project --auth-middlewares tokenVerification,authGuard
```

### 出力（YAML）

```yaml
_meta:
  framework: fastify
  projectRoot: /path/to/project
  extractedAt: "2025-12-29T12:00:00.000Z"

/users:
  endpoints:
    /:id:
      METHOD: GET
      pathParams:
        id: string
      requiresAuth: true
    /initialize:
      METHOD: POST
      bodyParams:
        uid: string
        code: string | undefined
        forceRegister: boolean | undefined
      requiresAuth: false
    /followers:
      METHOD: GET
      queryParams:
        id: string
        next: string | undefined
      requiresAuth: true
```

## アーキテクチャ概要

```
index.ts (CLI エントリーポイント)
    │
    ├── FrameworkDetector
    │   └── package.jsonからフレームワークを自動検出
    │
    ├── ExtractorFactory
    │   └── フレームワークに応じたExtractorを生成
    │
    ├── EndpointExtractor (インターフェース)
    │   │
    │   ├── FastifyExtractor
    │   │   ├── BuildFileParser
    │   │   ├── RouteFileParser
    │   │   └── AuthDetector
    │   │
    │   ├── NestJSExtractor (将来)
    │   │   ├── ControllerParser
    │   │   └── DecoratorParser
    │   │
    │   └── ExpressExtractor (将来)
    │
    ├── TypeExtractor (共通)
    │   └── ジェネリック型パラメータから型情報を抽出
    │
    └── YamlGenerator (共通)
        └── 解析結果をYAML形式で出力
```

## 設計原則

### 拡張性

1. **プラグインアーキテクチャ**: 新しいフレームワーク対応は`EndpointExtractor`実装の追加のみ
2. **共通基盤の再利用**: `TypeExtractor`, `YamlGenerator`は全フレームワークで共有
3. **設定の外部化**: 認証ミドルウェア名などはオプションで指定可能

### 認証解析

1. **設定可能な識別子**: プロジェクト固有の認証関数名に対応
2. **複数フックポイント対応**: `preHandler`, `onRequest`等
3. **デフォルト識別子リスト**: 一般的な命名パターンをカバー
