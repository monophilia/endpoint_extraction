# モデル/データ型設計

Updated: 2025/12/29 23:00

## 概要

Endpoint Extractorで使用するデータ型を定義する。
マルチフレームワーク対応のための抽象型と、認証解析のための設定型を含む。

---

## フレームワーク型 {#framework-type}

対応フレームワークを表す型。

```typescript
// src/types/framework.ts

/**
 * 対応フレームワーク
 */
export const FRAMEWORKS = ['fastify', 'nestjs', 'express'] as const;

export type FrameworkType = (typeof FRAMEWORKS)[number];

/**
 * フレームワーク検出結果
 */
export type FrameworkDetectionResult = {
  /** 検出されたフレームワーク */
  readonly framework: FrameworkType;
  /** 検出の確度（0-1） */
  readonly confidence: number;
  /** 検出根拠 */
  readonly reason: string;
};
```

---

## HTTPMethod型

HTTPメソッドを表す文字列リテラル型。

```typescript
// src/types/http.ts

export const HTTP_METHODS = ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'] as const;

export type HttpMethod = (typeof HTTP_METHODS)[number];
```

---

## ParamInfo型 {#param-info}

パラメータの情報を表す型。

```typescript
// src/types/param.ts

/**
 * パラメータ情報
 */
export type ParamInfo = {
  /** パラメータ名 */
  readonly name: string;
  /** TypeScript型（文字列表現） */
  readonly type: string;
  /** 必須かどうか */
  readonly required: boolean;
};
```

### 使用例

```typescript
const param: ParamInfo = {
  name: 'userId',
  type: 'string',
  required: true,
};

const optionalParam: ParamInfo = {
  name: 'limit',
  type: 'number',
  required: false,
};
```

---

## AuthConfig型 {#auth-config}

認証解析の設定を表す型。

```typescript
// src/types/auth.ts

/**
 * 認証ミドルウェアの検出フックポイント（Fastify）
 */
export const FASTIFY_AUTH_HOOKS = ['preHandler', 'onRequest', 'preValidation'] as const;

export type FastifyAuthHook = (typeof FASTIFY_AUTH_HOOKS)[number];

/**
 * デフォルトの認証ミドルウェア識別子
 */
export const DEFAULT_AUTH_MIDDLEWARES = [
  'tokenVerification',
  'authGuard',
  'authenticate',
  'requireAuth',
  'verifyToken',
  'isAuthenticated',
  'authMiddleware',
  'jwtVerify',
] as const;

/**
 * 認証解析設定
 */
export type AuthConfig = {
  /** 認証ミドルウェアの識別子リスト */
  readonly middlewareNames: readonly string[];
  /** 検出対象のフックポイント（Fastify用） */
  readonly hookPoints: readonly FastifyAuthHook[];
};

/**
 * デフォルトの認証設定
 */
export const DEFAULT_AUTH_CONFIG: AuthConfig = {
  middlewareNames: [...DEFAULT_AUTH_MIDDLEWARES],
  hookPoints: ['preHandler', 'onRequest'],
};
```

### 使用例

```typescript
// プロジェクト固有の認証関数名を追加
const customAuthConfig: AuthConfig = {
  middlewareNames: ['tokenVerification', 'customAuth', 'adminOnly'],
  hookPoints: ['preHandler', 'onRequest', 'preValidation'],
};
```

---

## EndpointInfo型 {#endpoint-info}

単一のエンドポイント情報を表す型。

```typescript
// src/types/endpoint.ts

import type { HttpMethod } from './http';
import type { ParamInfo } from './param';

/**
 * 認証情報の詳細
 */
export type AuthInfo = {
  /** 認証必須かどうか */
  readonly required: boolean;
  /** 検出されたミドルウェア名（複数の場合あり） */
  readonly middlewares: readonly string[];
  /** 検出されたフックポイント */
  readonly hookPoint?: string;
};

/**
 * エンドポイント情報
 */
export type EndpointInfo = {
  /** エンドポイントのパス（prefix含まない相対パス） */
  readonly path: string;
  /** HTTPメソッド */
  readonly method: HttpMethod;
  /** パスパラメータ（:idなど） */
  readonly pathParams: readonly ParamInfo[];
  /** クエリパラメータ */
  readonly queryParams: readonly ParamInfo[];
  /** ボディパラメータ */
  readonly bodyParams: readonly ParamInfo[];
  /** 認証情報 */
  readonly auth: AuthInfo;
  /** ソースファイルパス */
  readonly sourceFile: string;
  /** 定義行番号 */
  readonly lineNumber: number;
};

/**
 * 後方互換性のためのヘルパー（requiresAuthプロパティ）
 */
export const hasAuth = (endpoint: EndpointInfo): boolean => endpoint.auth.required;
```

### 使用例

```typescript
const endpoint: EndpointInfo = {
  path: '/:id',
  method: 'GET',
  pathParams: [{ name: 'id', type: 'string', required: true }],
  queryParams: [],
  bodyParams: [],
  auth: {
    required: true,
    middlewares: ['tokenVerification'],
    hookPoint: 'preHandler',
  },
  sourceFile: 'src/routes/users.ts',
  lineNumber: 70,
};
```

---

## RouteRegistration型 {#route-registration}

build.tsで登録されたルート情報を表す型（Fastify固有）。

```typescript
// src/types/route.ts

/**
 * ルート登録情報（build.tsのapp.register呼び出し）
 */
export type RouteRegistration = {
  /** import名（例: 'Users', 'Rooms'） */
  readonly importName: string;
  /** ルートファイルの相対パス（例: './routes/users'） */
  readonly importPath: string;
  /** URLプレフィックス（例: '/users'） */
  readonly prefix: string;
  /** 解決済みファイルパス */
  readonly resolvedFilePath: string;
};
```

---

## PrefixedEndpoints型 {#prefixed-endpoints}

prefixごとにグループ化されたエンドポイント。

```typescript
// src/types/output.ts

import type { EndpointInfo } from './endpoint';

/**
 * prefixごとのエンドポイント情報
 */
export type PrefixedEndpoints = {
  /** URLプレフィックス */
  readonly prefix: string;
  /** このprefixに属するエンドポイント */
  readonly endpoints: readonly EndpointInfo[];
};
```

---

## ExtractedEndpoints型 {#extracted-endpoints}

抽出結果全体を表す型。

```typescript
// src/types/output.ts

import type { FrameworkType } from './framework';

/**
 * 抽出結果全体
 */
export type ExtractedEndpoints = {
  /** 検出されたフレームワーク */
  readonly framework: FrameworkType;
  /** プロジェクトルートパス */
  readonly projectRoot: string;
  /** エントリーポイントファイルのパス */
  readonly entryFilePath: string;
  /** prefixごとのエンドポイント */
  readonly routes: readonly PrefixedEndpoints[];
  /** 抽出日時 */
  readonly extractedAt: string;
  /** 認証が必要なエンドポイント数 */
  readonly authRequiredCount: number;
  /** 認証不要なエンドポイント数 */
  readonly publicCount: number;
};
```

### 使用例

```typescript
const result: ExtractedEndpoints = {
  framework: 'fastify',
  projectRoot: '/path/to/project',
  entryFilePath: '/path/to/project/src/build.ts',
  routes: [
    {
      prefix: '/users',
      endpoints: [
        {
          path: '/:id',
          method: 'GET',
          pathParams: [{ name: 'id', type: 'string', required: true }],
          queryParams: [],
          bodyParams: [],
          auth: { required: true, middlewares: ['tokenVerification'], hookPoint: 'preHandler' },
          sourceFile: 'src/routes/users.ts',
          lineNumber: 70,
        },
      ],
    },
  ],
  extractedAt: '2025-12-29T12:50:00.000Z',
  authRequiredCount: 35,
  publicCount: 12,
};
```

---

## EndpointExtractor インターフェース {#endpoint-extractor}

フレームワーク固有のExtractor実装が従うべきインターフェース。

```typescript
// src/extractors/types.ts

import type { ExtractedEndpoints } from '../types/output';
import type { ExtractorOptions } from '../types/options';

/**
 * エンドポイント抽出器のインターフェース
 * 各フレームワーク用のExtractorはこのインターフェースを実装する
 */
export interface EndpointExtractor {
  /**
   * Extractorがサポートするフレームワーク
   */
  readonly framework: FrameworkType;

  /**
   * プロジェクトからエンドポイントを抽出
   * @param options 抽出オプション
   * @returns 抽出結果
   */
  extract(options: ExtractorOptions): Promise<ExtractedEndpoints>;

  /**
   * このExtractorがプロジェクトを処理できるか判定
   * @param projectRoot プロジェクトルートパス
   * @returns 処理可能な場合true
   */
  canHandle(projectRoot: string): Promise<boolean>;
}
```

### 実装例（Fastify）

```typescript
// src/extractors/fastify/index.ts

export class FastifyExtractor implements EndpointExtractor {
  readonly framework: FrameworkType = 'fastify';

  async extract(options: ExtractorOptions): Promise<ExtractedEndpoints> {
    // Fastify固有の解析ロジック
  }

  async canHandle(projectRoot: string): Promise<boolean> {
    // package.jsonにfastifyがあるか確認
  }
}
```

---

## ExtractorOptions型 {#extractor-options}

Extractorのオプション。

```typescript
// src/types/options.ts

import type { AuthConfig } from './auth';
import type { FrameworkType } from './framework';

/**
 * Extractorオプション
 */
export type ExtractorOptions = {
  /** プロジェクトルートパス */
  readonly projectRoot: string;
  /** エントリーポイントファイルの相対パス */
  readonly entryFilePath?: string;
  /** tsconfigのパス */
  readonly tsconfigPath?: string;
  /** 認証解析設定 */
  readonly authConfig?: AuthConfig;
  /** 詳細ログ出力 */
  readonly verbose?: boolean;
};

/**
 * CLIオプション（フレームワーク指定を含む）
 */
export type CLIOptions = ExtractorOptions & {
  /** フレームワーク（省略時は自動検出） */
  readonly framework?: FrameworkType;
  /** 出力ファイルパス */
  readonly outputPath?: string;
};
```

---

## YamlEndpoint型 {#yaml-endpoint}

YAML出力用のエンドポイント表現。

```typescript
// src/types/yaml.ts

/**
 * YAML出力用のパラメータ
 * キー: パラメータ名, 値: 型文字列
 */
export type YamlParams = {
  readonly [key: string]: string;
};

/**
 * YAML出力用のエンドポイント
 */
export type YamlEndpoint = {
  readonly METHOD: string;
  readonly pathParams?: YamlParams;
  readonly queryParams?: YamlParams;
  readonly bodyParams?: YamlParams;
  readonly requiresAuth: boolean;
  readonly authMiddlewares?: readonly string[];
};

/**
 * YAML出力用のルート（prefix単位）
 */
export type YamlRoute = {
  readonly endpoints: {
    readonly [path: string]: YamlEndpoint;
  };
};

/**
 * YAML出力のメタ情報
 */
export type YamlMeta = {
  readonly framework: string;
  readonly projectRoot: string;
  readonly extractedAt: string;
  readonly totalEndpoints: number;
  readonly authRequiredCount: number;
  readonly publicCount: number;
};

/**
 * YAML出力の最終形式
 */
export type YamlOutput = {
  readonly _meta: YamlMeta;
  readonly [prefix: string]: YamlRoute | YamlMeta;
};
```

---

## 型定義ファイル構成

```
src/
├── types/
│   ├── index.ts          # 全型のre-export
│   ├── framework.ts      # FrameworkType, FrameworkDetectionResult
│   ├── http.ts           # HttpMethod
│   ├── param.ts          # ParamInfo
│   ├── auth.ts           # AuthConfig, AuthInfo
│   ├── endpoint.ts       # EndpointInfo
│   ├── route.ts          # RouteRegistration
│   ├── output.ts         # PrefixedEndpoints, ExtractedEndpoints
│   ├── yaml.ts           # YAML出力用型
│   └── options.ts        # ExtractorOptions, CLIOptions
│
└── extractors/
    └── types.ts          # EndpointExtractor インターフェース
```

### index.ts

```typescript
// src/types/index.ts

export type { FrameworkType, FrameworkDetectionResult } from './framework';
export { FRAMEWORKS } from './framework';
export type { HttpMethod } from './http';
export { HTTP_METHODS } from './http';
export type { ParamInfo } from './param';
export type { AuthConfig, AuthInfo, FastifyAuthHook } from './auth';
export { DEFAULT_AUTH_CONFIG, DEFAULT_AUTH_MIDDLEWARES, FASTIFY_AUTH_HOOKS } from './auth';
export type { EndpointInfo } from './endpoint';
export { hasAuth } from './endpoint';
export type { RouteRegistration } from './route';
export type { PrefixedEndpoints, ExtractedEndpoints } from './output';
export type { YamlParams, YamlEndpoint, YamlRoute, YamlMeta, YamlOutput } from './yaml';
export type { ExtractorOptions, CLIOptions } from './options';
```

---

## 型の関係図

```
CLIOptions
    │
    ├── framework? ──────► FrameworkDetector
    │                            │
    │                            ▼
    │                      FrameworkType
    │                            │
    ▼                            ▼
ExtractorOptions ──────► ExtractorFactory
    │                            │
    ├── authConfig               ▼
    │       │              EndpointExtractor
    │       ▼                    │
    │   AuthConfig               ├── FastifyExtractor
    │                            ├── NestJSExtractor (将来)
    │                            └── ExpressExtractor (将来)
    │                                 │
    │                                 ▼
    │                          EndpointInfo[]
    │                                 │
    │                                 ├── auth: AuthInfo
    │                                 │
    │                                 ▼
    │                          PrefixedEndpoints[]
    │                                 │
    │                                 ▼
    │                          ExtractedEndpoints
    │                                 │
    │                                 ▼
    └──────────────────────► YamlGenerator
                                     │
                                     ▼
                                YamlOutput
                                     │
                                     ▼
                                YAML文字列
```

---

## NestJS対応時の型拡張（参考） {#nestjs-types}

NestJS対応時に追加される型の参考設計。

```typescript
// src/types/nestjs.ts（将来）

/**
 * NestJSコントローラー情報
 */
export type ControllerInfo = {
  /** コントローラークラス名 */
  readonly className: string;
  /** @Controller()のパス */
  readonly basePath: string;
  /** ソースファイルパス */
  readonly sourceFile: string;
};

/**
 * NestJSデコレータ情報
 */
export type DecoratorInfo = {
  /** デコレータ名（Get, Post, etc.） */
  readonly name: string;
  /** デコレータ引数（パス） */
  readonly path: string;
  /** メソッド名 */
  readonly methodName: string;
  /** 行番号 */
  readonly lineNumber: number;
};

/**
 * NestJS認証デコレータ
 */
export const NESTJS_AUTH_DECORATORS = [
  'UseGuards',
  'Auth',
  'Authenticated',
  'Public', // 認証不要を示すデコレータ
] as const;
```
