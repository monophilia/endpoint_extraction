# モデル/データ型設計

Updated: 2025/12/29 21:50

## 概要

Fastifyエンドポイント抽出ツールで使用するデータ型を定義する。

---

## HTTPMethod型

HTTPメソッドを表す文字列リテラル型。

```typescript
// src/types/http.ts

export const HTTP_METHODS = ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'] as const;

export type HttpMethod = (typeof HTTP_METHODS)[number];
```

---

## ParamInfo型 {#param-info}

パラメータの情報を表す型。

```typescript
// src/types/param.ts

/**
 * パラメータ情報
 */
export type ParamInfo = {
  /** パラメータ名 */
  readonly name: string;
  /** TypeScript型（文字列表現） */
  readonly type: string;
  /** 必須かどうか */
  readonly required: boolean;
};
```

### 使用例

```typescript
const param: ParamInfo = {
  name: 'userId',
  type: 'string',
  required: true,
};

const optionalParam: ParamInfo = {
  name: 'limit',
  type: 'number',
  required: false,
};
```

---

## EndpointInfo型 {#endpoint-info}

単一のエンドポイント情報を表す型。

```typescript
// src/types/endpoint.ts

import type { HttpMethod } from './http';
import type { ParamInfo } from './param';

/**
 * エンドポイント情報
 */
export type EndpointInfo = {
  /** エンドポイントのパス（prefix含まない相対パス） */
  readonly path: string;
  /** HTTPメソッド */
  readonly method: HttpMethod;
  /** パスパラメータ（:idなど） */
  readonly pathParams: readonly ParamInfo[];
  /** クエリパラメータ */
  readonly queryParams: readonly ParamInfo[];
  /** ボディパラメータ */
  readonly bodyParams: readonly ParamInfo[];
  /** 認証必須かどうか（preHandlerにtokenVerificationがあるか） */
  readonly requiresAuth: boolean;
  /** ソースファイルパス */
  readonly sourceFile: string;
  /** 定義行番号 */
  readonly lineNumber: number;
};
```

### 使用例

```typescript
const endpoint: EndpointInfo = {
  path: '/:id',
  method: 'GET',
  pathParams: [{ name: 'id', type: 'string', required: true }],
  queryParams: [],
  bodyParams: [],
  requiresAuth: true,
  sourceFile: 'src/routes/users.ts',
  lineNumber: 70,
};
```

---

## RouteRegistration型 {#route-registration}

build.tsで登録されたルート情報を表す型。

```typescript
// src/types/route.ts

/**
 * ルート登録情報（build.tsのapp.register呼び出し）
 */
export type RouteRegistration = {
  /** import名（例: 'Users', 'Rooms'） */
  readonly importName: string;
  /** ルートファイルの相対パス（例: './routes/users'） */
  readonly importPath: string;
  /** URLプレフィックス（例: '/users'） */
  readonly prefix: string;
  /** 解決済みファイルパス */
  readonly resolvedFilePath: string;
};
```

### 使用例

```typescript
const registration: RouteRegistration = {
  importName: 'Users',
  importPath: './routes/users',
  prefix: '/users',
  resolvedFilePath: '/path/to/project/src/routes/users.ts',
};
```

---

## PrefixedEndpoints型 {#prefixed-endpoints}

prefixごとにグループ化されたエンドポイント。

```typescript
// src/types/output.ts

import type { EndpointInfo } from './endpoint';

/**
 * prefixごとのエンドポイント情報
 */
export type PrefixedEndpoints = {
  /** URLプレフィックス */
  readonly prefix: string;
  /** このprefixに属するエンドポイント */
  readonly endpoints: readonly EndpointInfo[];
};
```

---

## ExtractedEndpoints型 {#extracted-endpoints}

抽出結果全体を表す型。

```typescript
// src/types/output.ts

/**
 * 抽出結果全体
 */
export type ExtractedEndpoints = {
  /** プロジェクトルートパス */
  readonly projectRoot: string;
  /** build.tsのパス */
  readonly buildFilePath: string;
  /** prefixごとのエンドポイント */
  readonly routes: readonly PrefixedEndpoints[];
  /** 抽出日時 */
  readonly extractedAt: string;
};
```

### 使用例

```typescript
const result: ExtractedEndpoints = {
  projectRoot: '/path/to/project',
  buildFilePath: '/path/to/project/src/build.ts',
  routes: [
    {
      prefix: '/users',
      endpoints: [
        {
          path: '/:id',
          method: 'GET',
          pathParams: [{ name: 'id', type: 'string', required: true }],
          queryParams: [],
          bodyParams: [],
          requiresAuth: true,
          sourceFile: 'src/routes/users.ts',
          lineNumber: 70,
        },
      ],
    },
  ],
  extractedAt: '2025-12-29T12:50:00.000Z',
};
```

---

## YamlEndpoint型 {#yaml-endpoint}

YAML出力用のエンドポイント表現。

```typescript
// src/types/yaml.ts

/**
 * YAML出力用のパラメータ
 * キー: パラメータ名, 値: 型文字列
 */
export type YamlParams = {
  readonly [key: string]: string;
};

/**
 * YAML出力用のエンドポイント
 */
export type YamlEndpoint = {
  readonly METHOD: string;
  readonly pathParams?: YamlParams;
  readonly queryParams?: YamlParams;
  readonly bodyParams?: YamlParams;
  readonly requiresAuth?: boolean;
};

/**
 * YAML出力用のルート（prefix単位）
 */
export type YamlRoute = {
  readonly endpoints: {
    readonly [path: string]: YamlEndpoint;
  };
};

/**
 * YAML出力の最終形式
 */
export type YamlOutput = {
  readonly [prefix: string]: YamlRoute;
};
```

### YAML出力例

```yaml
/users:
  endpoints:
    /:id:
      METHOD: GET
      pathParams:
        id: string
      requiresAuth: true
    /initialize:
      METHOD: POST
      bodyParams:
        uid: string
        code: string | undefined
        forceRegister: boolean | undefined
      requiresAuth: false
```

---

## ParserOptions型

パーサーのオプション。

```typescript
// src/types/options.ts

/**
 * パーサーオプション
 */
export type ParserOptions = {
  /** プロジェクトルートパス */
  readonly projectRoot: string;
  /** build.tsの相対パス（デフォルト: 'src/build.ts'） */
  readonly buildFilePath?: string;
  /** tsconfigのパス */
  readonly tsconfigPath?: string;
  /** 詳細ログ出力 */
  readonly verbose?: boolean;
};
```

---

## 型定義ファイル構成

```
src/
└── types/
    ├── index.ts          # 全型のre-export
    ├── http.ts           # HttpMethod
    ├── param.ts          # ParamInfo
    ├── endpoint.ts       # EndpointInfo
    ├── route.ts          # RouteRegistration
    ├── output.ts         # PrefixedEndpoints, ExtractedEndpoints
    ├── yaml.ts           # YAML出力用型
    └── options.ts        # ParserOptions
```

### index.ts

```typescript
// src/types/index.ts

export type { HttpMethod } from './http';
export { HTTP_METHODS } from './http';
export type { ParamInfo } from './param';
export type { EndpointInfo } from './endpoint';
export type { RouteRegistration } from './route';
export type { PrefixedEndpoints, ExtractedEndpoints } from './output';
export type { YamlParams, YamlEndpoint, YamlRoute, YamlOutput } from './yaml';
export type { ParserOptions } from './options';
```

---

## 型の関係図

```
ParserOptions
    │
    ▼
BuildFileParser ──────────► RouteRegistration[]
                                   │
                                   ▼
RouteFileParser ──────────► EndpointInfo[]
    │                              │
    │                              ▼
    └───► TypeExtractor ──► ParamInfo[]
                                   │
                                   ▼
                          PrefixedEndpoints[]
                                   │
                                   ▼
                          ExtractedEndpoints
                                   │
                                   ▼
YamlGenerator ────────────► YamlOutput
                                   │
                                   ▼
                              YAML文字列
```
