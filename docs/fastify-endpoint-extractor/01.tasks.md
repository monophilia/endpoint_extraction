# タスクリスト: Endpoint Extractor

Updated: 2025/12/29 23:00

## 復旧手順

このファイルを読み込んだ場合、以下を実行:
1. 下記のTodo一覧をTodoWriteで設定
2. in_progressのタスクから作業再開
3. 該当タスクの詳細セクションを参照

---

## Todo一覧（TodoWrite用）

| # | タスク | 状態 | 進行形 |
|---|--------|------|--------|
| 1 | ts-morph, yamlパッケージをインストール | pending | パッケージをインストールしている |
| 2 | FrameworkType型を定義する | pending | FrameworkType型を定義している |
| 3 | AuthConfig型を定義する | pending | AuthConfig型を定義している |
| 4 | EndpointInfo型を定義する（AuthInfo含む） | pending | EndpointInfo型を定義している |
| 5 | ExtractorOptions型を定義する | pending | ExtractorOptions型を定義している |
| 6 | EndpointExtractorインターフェースを定義する | pending | EndpointExtractorインターフェースを定義している |
| 7 | FrameworkDetector用テストを作成する | pending | FrameworkDetector用テストを作成している |
| 8 | AuthDetector用テストを作成する | pending | AuthDetector用テストを作成している |
| 9 | BuildFileParser用テストを作成する | pending | BuildFileParser用テストを作成している |
| 10 | RouteFileParser用テストを作成する | pending | RouteFileParser用テストを作成している |
| 11 | TypeExtractor用テストを作成する | pending | TypeExtractor用テストを作成している |
| 12 | YamlGenerator用テストを作成する | pending | YamlGenerator用テストを作成している |
| 13 | FrameworkDetectorを実装する | pending | FrameworkDetectorを実装している |
| 14 | ExtractorFactoryを実装する | pending | ExtractorFactoryを実装している |
| 15 | AuthDetectorを実装する | pending | AuthDetectorを実装している |
| 16 | BuildFileParserを実装する | pending | BuildFileParserを実装している |
| 17 | RouteFileParserを実装する（AuthDetector統合） | pending | RouteFileParserを実装している |
| 18 | TypeExtractorを実装する | pending | TypeExtractorを実装している |
| 19 | FastifyExtractorを実装する | pending | FastifyExtractorを実装している |
| 20 | YamlGeneratorを実装する | pending | YamlGeneratorを実装している |
| 21 | CLIエントリーポイントを実装する | pending | CLIエントリーポイントを実装している |
| 22 | 実プロジェクトでテスト実行する | pending | 実プロジェクトでテスト実行している |

---

## タスク詳細

### タスク1: ts-morph, yamlパッケージをインストール

**状態**: pending
**参照設計書**: [00.index.md](./00.index.md#依存関係)

**作業内容**:
1. `bun add ts-morph yaml` を実行
2. package.jsonに追加されたことを確認

**担当ファイル**:
- `package.json`
- `bun.lock`

**完了条件**:
- [ ] ts-morphがインストールされている
- [ ] yamlがインストールされている

---

### タスク2: FrameworkType型を定義する

**状態**: pending
**参照設計書**: [02.models.md](./02.models.md#framework-type)

**作業内容**:
1. `src/types/framework.ts` を作成
2. FRAMEWORKS定数を定義
3. FrameworkType型を定義
4. FrameworkDetectionResult型を定義

**担当ファイル**:
- `src/types/framework.ts`

**完了条件**:
- [ ] 型定義が設計書と一致
- [ ] エクスポートされている

---

### タスク3: AuthConfig型を定義する

**状態**: pending
**参照設計書**: [02.models.md](./02.models.md#auth-config)

**作業内容**:
1. `src/types/auth.ts` を作成
2. FASTIFY_AUTH_HOOKS定数を定義
3. DEFAULT_AUTH_MIDDLEWARES定数を定義
4. AuthConfig型を定義
5. DEFAULT_AUTH_CONFIG定数を定義

**担当ファイル**:
- `src/types/auth.ts`

**完了条件**:
- [ ] 型定義が設計書と一致
- [ ] デフォルト設定が定義されている

---

### タスク4: EndpointInfo型を定義する（AuthInfo含む）

**状態**: pending
**参照設計書**: [02.models.md](./02.models.md#endpoint-info)

**作業内容**:
1. `src/types/endpoint.ts` を更新
2. AuthInfo型を追加
3. EndpointInfo型にauthプロパティを追加
4. hasAuthヘルパー関数を追加

**担当ファイル**:
- `src/types/endpoint.ts`

**完了条件**:
- [ ] AuthInfo型が定義されている
- [ ] EndpointInfo.authプロパティが存在
- [ ] hasAuth関数がエクスポートされている

---

### タスク5: ExtractorOptions型を定義する

**状態**: pending
**参照設計書**: [02.models.md](./02.models.md#extractor-options)

**作業内容**:
1. `src/types/options.ts` を更新
2. ExtractorOptions型を定義
3. CLIOptions型を定義

**担当ファイル**:
- `src/types/options.ts`

**完了条件**:
- [ ] ExtractorOptions型にauthConfigが含まれている
- [ ] CLIOptionsにframeworkが含まれている

---

### タスク6: EndpointExtractorインターフェースを定義する

**状態**: pending
**参照設計書**: [02.models.md](./02.models.md#endpoint-extractor)

**作業内容**:
1. `src/extractors/types.ts` を作成
2. EndpointExtractorインターフェースを定義
3. framework, extract, canHandleメソッドを定義

**担当ファイル**:
- `src/extractors/types.ts`

**完了条件**:
- [ ] インターフェースが設計書と一致
- [ ] 全メソッドが定義されている

---

### タスク7: FrameworkDetector用テストを作成する

**状態**: pending
**参照設計書**: [06.extractor-architecture.md](./06.extractor-architecture.md#framework-detector)

**作業内容**:
1. `src/__tests__/frameworkDetector.test.ts` を作成
2. Fastify検出テスト
3. NestJS検出テスト（優先度確認）
4. フレームワークなしのテスト

**担当ファイル**:
- `src/__tests__/frameworkDetector.test.ts`
- `src/__tests__/fixtures/package.fixture.ts`

**完了条件**:
- [ ] 各フレームワークの検出テストがある
- [ ] 優先度のテストがある
- [ ] テストが実行可能（FAILするのが正常）

---

### タスク8: AuthDetector用テストを作成する

**状態**: pending
**参照設計書**: [04.parser-implementation.md](./04.parser-implementation.md#auth-detector)

**作業内容**:
1. `src/__tests__/authDetector.test.ts` を作成
2. `src/__tests__/fixtures/auth.fixture.ts` を作成
3. preHandler検出テスト
4. onRequest検出テスト
5. 複数フックテスト
6. カスタム認証関数テスト

**担当ファイル**:
- `src/__tests__/authDetector.test.ts`
- `src/__tests__/fixtures/auth.fixture.ts`

**完了条件**:
- [ ] 全フックポイントのテストがある
- [ ] 設定可能なミドルウェア名のテストがある
- [ ] テストが実行可能（FAILするのが正常）

---

### タスク9: BuildFileParser用テストを作成する

**状態**: pending
**参照設計書**: [03.tests.md](./03.tests.md#build-file-parser)

**作業内容**:
1. `src/__tests__/buildFileParser.test.ts` を作成
2. 正常系: app.register解析テスト
3. 正常系: 複数ルート登録の解析テスト
4. 異常系: 不正な形式のテスト

**担当ファイル**:
- `src/__tests__/buildFileParser.test.ts`
- `src/__tests__/fixtures/build.fixture.ts`

**完了条件**:
- [ ] 設計書の全テストケースが実装されている
- [ ] テストが実行可能（FAILするのが正常）

---

### タスク10: RouteFileParser用テストを作成する

**状態**: pending
**参照設計書**: [03.tests.md](./03.tests.md#route-file-parser)

**作業内容**:
1. `src/__tests__/routeFileParser.test.ts` を作成
2. 正常系: GET/POST/PUT/DELETE/PATCH解析テスト
3. 正常系: ジェネリック型パラメータ解析テスト
4. 正常系: 認証情報抽出テスト（AuthDetector統合）

**担当ファイル**:
- `src/__tests__/routeFileParser.test.ts`
- `src/__tests__/fixtures/route.fixture.ts`

**完了条件**:
- [ ] 設計書の全テストケースが実装されている
- [ ] 認証情報抽出のテストがある
- [ ] テストが実行可能（FAILするのが正常）

---

### タスク11: TypeExtractor用テストを作成する

**状態**: pending
**参照設計書**: [03.tests.md](./03.tests.md#type-extractor)

**作業内容**:
1. `src/__tests__/typeExtractor.test.ts` を作成
2. 正常系: 型リテラルからプロパティ抽出
3. 正常系: 型参照の解決
4. 正常系: オプショナルプロパティの扱い

**担当ファイル**:
- `src/__tests__/typeExtractor.test.ts`

**完了条件**:
- [ ] 設計書の全テストケースが実装されている
- [ ] テストが実行可能（FAILするのが正常）

---

### タスク12: YamlGenerator用テストを作成する

**状態**: pending
**参照設計書**: [03.tests.md](./03.tests.md#yaml-generator)

**作業内容**:
1. `src/__tests__/yamlGenerator.test.ts` を作成
2. 正常系: 単一エンドポイントのYAML出力
3. 正常系: 認証情報付きYAML出力
4. 正常系: メタ情報出力

**担当ファイル**:
- `src/__tests__/yamlGenerator.test.ts`

**完了条件**:
- [ ] 設計書の全テストケースが実装されている
- [ ] 認証情報のYAML出力テストがある
- [ ] テストが実行可能（FAILするのが正常）

---

### タスク13: FrameworkDetectorを実装する

**状態**: pending
**参照設計書**: [06.extractor-architecture.md](./06.extractor-architecture.md#framework-detector)

**作業内容**:
1. `src/core/frameworkDetector.ts` を作成
2. FRAMEWORK_PATTERNS定数を定義
3. detect メソッドを実装
4. isFramework メソッドを実装

**担当ファイル**:
- `src/core/frameworkDetector.ts`

**完了条件**:
- [ ] タスク7のテストが全てパスする
- [ ] 各フレームワークが正しく検出される

---

### タスク14: ExtractorFactoryを実装する

**状態**: pending
**参照設計書**: [06.extractor-architecture.md](./06.extractor-architecture.md#extractor-factory)

**作業内容**:
1. `src/core/extractorFactory.ts` を作成
2. EXTRACTORS Map を定義
3. getExtractor メソッドを実装
4. getExtractorForProject メソッドを実装

**担当ファイル**:
- `src/core/extractorFactory.ts`

**完了条件**:
- [ ] Fastify用Extractorが取得できる
- [ ] 自動検出からExtractor取得ができる

---

### タスク15: AuthDetectorを実装する

**状態**: pending
**参照設計書**: [04.parser-implementation.md](./04.parser-implementation.md#auth-detector)

**作業内容**:
1. `src/extractors/fastify/authDetector.ts` を作成
2. detect メソッドを実装
3. extractMiddlewareNames メソッドを実装
4. isAuthMiddleware メソッドを実装

**担当ファイル**:
- `src/extractors/fastify/authDetector.ts`

**完了条件**:
- [ ] タスク8のテストが全てパスする
- [ ] 複数フックポイントに対応
- [ ] 設定可能なミドルウェア名に対応

---

### タスク16: BuildFileParserを実装する

**状態**: pending
**参照設計書**: [04.parser-implementation.md](./04.parser-implementation.md#build-file-parser)

**作業内容**:
1. `src/extractors/fastify/buildFileParser.ts` を作成
2. app.register呼び出しを検出
3. ルートモジュール名とprefixを抽出
4. importパスからルートファイルパスを解決

**担当ファイル**:
- `src/extractors/fastify/buildFileParser.ts`

**完了条件**:
- [ ] タスク9のテストが全てパスする
- [ ] エラーハンドリングが適切

---

### タスク17: RouteFileParserを実装する（AuthDetector統合）

**状態**: pending
**参照設計書**: [04.parser-implementation.md](./04.parser-implementation.md#route-file-parser)

**作業内容**:
1. `src/extractors/fastify/routeFileParser.ts` を作成
2. server.get/post/put/delete/patch呼び出しを検出
3. AuthDetectorを統合して認証情報を抽出
4. EndpointInfo.authプロパティを設定

**担当ファイル**:
- `src/extractors/fastify/routeFileParser.ts`

**完了条件**:
- [ ] タスク10のテストが全てパスする
- [ ] 認証情報が正しく抽出される

---

### タスク18: TypeExtractorを実装する

**状態**: pending
**参照設計書**: [04.parser-implementation.md](./04.parser-implementation.md#type-extractor)

**作業内容**:
1. `src/core/typeExtractor.ts` を作成
2. 型リテラルからプロパティ名と型を抽出
3. 型参照を解決して実際の型定義を取得
4. オプショナル/必須の判定

**担当ファイル**:
- `src/core/typeExtractor.ts`

**完了条件**:
- [ ] タスク11のテストが全てパスする
- [ ] 型参照の解決ができる

---

### タスク19: FastifyExtractorを実装する

**状態**: pending
**参照設計書**: [06.extractor-architecture.md](./06.extractor-architecture.md#fastify-extractor)

**作業内容**:
1. `src/extractors/fastify/index.ts` を作成
2. EndpointExtractorインターフェースを実装
3. extract メソッドを実装
4. canHandle メソッドを実装

**担当ファイル**:
- `src/extractors/fastify/index.ts`

**完了条件**:
- [ ] EndpointExtractorインターフェースを満たす
- [ ] 統計情報（authRequiredCount, publicCount）が正しい

---

### タスク20: YamlGeneratorを実装する

**状態**: pending
**参照設計書**: [05.yaml-output.md](./05.yaml-output.md)

**作業内容**:
1. `src/generators/yamlGenerator.ts` を作成
2. ExtractedEndpointsをYAML形式に変換
3. 認証情報を含める
4. メタ情報（framework, 統計）を含める

**担当ファイル**:
- `src/generators/yamlGenerator.ts`

**完了条件**:
- [ ] タスク12のテストが全てパスする
- [ ] 出力形式が設計書と一致

---

### タスク21: CLIエントリーポイントを実装する

**状態**: pending
**参照設計書**: [06.extractor-architecture.md](./06.extractor-architecture.md#cli-entry)

**作業内容**:
1. `index.ts` を実装
2. コマンドライン引数の解析（--framework, --auth-middlewares等）
3. ExtractorFactoryを使用したExtractor取得
4. 結果の出力とサマリー表示

**担当ファイル**:
- `index.ts`

**完了条件**:
- [ ] コマンドライン引数でフレームワーク指定ができる
- [ ] 認証ミドルウェア指定ができる
- [ ] YAML出力ができる
- [ ] サマリーが表示される

---

### タスク22: 実プロジェクトでテスト実行する

**状態**: pending
**参照設計書**: なし

**作業内容**:
1. voice-app-test/serverプロジェクトで実行
2. 出力結果を検証（エンドポイント数、認証情報）
3. 不足している機能があれば追加

**担当ファイル**:
- なし（テスト実行のみ）

**完了条件**:
- [ ] 実プロジェクトで正常に動作する
- [ ] 全エンドポイントが抽出される
- [ ] 認証情報が正しく検出される
- [ ] YAML出力が期待通り

---

## 実装順序の依存関係

```
タスク1 (パッケージインストール)
    │
    ▼
タスク2-6 (型定義) ─── 並列実行可能
    │
    ▼
タスク7-12 (テスト作成) ─── 並列実行可能
    │
    ▼
タスク13 (FrameworkDetector)
    │
    ▼
タスク14 (ExtractorFactory)
    │
    ├──► タスク15 (AuthDetector)
    │         │
    │         ▼
    │    タスク17 (RouteFileParser)
    │
    ├──► タスク16 (BuildFileParser)
    │
    └──► タスク18 (TypeExtractor)
              │
              ▼
         タスク19 (FastifyExtractor)
              │
              ▼
         タスク20 (YamlGenerator)
              │
              ▼
         タスク21 (CLI)
              │
              ▼
         タスク22 (実プロジェクトテスト)
```
