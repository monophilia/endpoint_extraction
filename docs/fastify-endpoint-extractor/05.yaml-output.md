# YAML出力設計

Updated: 2025/12/29 21:50

## 概要

抽出したエンドポイント情報をYAML形式で出力する機能の設計。

---

## 出力形式

### 基本構造

```yaml
# 生成情報
_meta:
  projectRoot: /path/to/project
  buildFile: src/build.ts
  extractedAt: "2025-12-29T12:00:00.000Z"
  totalEndpoints: 42

# ルート定義（prefix単位）
/users:
  endpoints:
    /:id:
      METHOD: GET
      pathParams:
        id: string
      requiresAuth: true
    /initialize:
      METHOD: POST
      bodyParams:
        uid: string
        code: string | undefined
        forceRegister: boolean | undefined
        tokenType: "'token' | 'spotToken' | undefined"
      requiresAuth: false

/rooms:
  endpoints:
    /:
      METHOD: GET
      queryParams:
        name: string | undefined
        roomId: string | undefined
      requiresAuth: true
```

### パラメータ表現

| 種類 | 表現 |
|------|------|
| 必須パラメータ | `name: string` |
| オプショナルパラメータ | `name: string \| undefined` |
| リテラル型 | `type: "'active' \| 'inactive'"` |
| ユニオン型 | `value: string \| number` |
| オブジェクト型 | `user: "{ name: string; id: number; }"` |
| 配列型 | `items: string[]` |

---

## YamlGenerator実装

```typescript
// src/generators/yamlGenerator.ts

import YAML from 'yaml';
import type {
  ExtractedEndpoints,
  EndpointInfo,
  ParamInfo,
  YamlOutput,
  YamlRoute,
  YamlEndpoint,
  YamlParams,
} from '../types';

export class YamlGenerator {
  /**
   * 抽出結果をYAML文字列に変換
   */
  generate(data: ExtractedEndpoints): string {
    const output = this.buildYamlOutput(data);
    return YAML.stringify(output, {
      indent: 2,
      lineWidth: 0, // 行の折り返しを無効化
    });
  }

  /**
   * YAML出力用のオブジェクトを構築
   */
  private buildYamlOutput(data: ExtractedEndpoints): Record<string, unknown> {
    const output: Record<string, unknown> = {
      _meta: {
        projectRoot: data.projectRoot,
        buildFile: data.buildFilePath,
        extractedAt: data.extractedAt,
        totalEndpoints: data.routes.reduce(
          (sum, route) => sum + route.endpoints.length,
          0
        ),
      },
    };

    // 各prefixのルートを追加
    data.routes.forEach(route => {
      output[route.prefix] = this.buildYamlRoute(route.endpoints);
    });

    return output;
  }

  /**
   * ルート（prefix単位）のYAML表現を構築
   */
  private buildYamlRoute(endpoints: readonly EndpointInfo[]): YamlRoute {
    const endpointsMap: Record<string, YamlEndpoint> = {};

    endpoints.forEach(endpoint => {
      endpointsMap[endpoint.path] = this.buildYamlEndpoint(endpoint);
    });

    return { endpoints: endpointsMap };
  }

  /**
   * エンドポイントのYAML表現を構築
   */
  private buildYamlEndpoint(endpoint: EndpointInfo): YamlEndpoint {
    const result: Record<string, unknown> = {
      METHOD: endpoint.method,
    };

    // パスパラメータ（存在する場合のみ）
    if (endpoint.pathParams.length > 0) {
      result.pathParams = this.buildYamlParams(endpoint.pathParams);
    }

    // クエリパラメータ（存在する場合のみ）
    if (endpoint.queryParams.length > 0) {
      result.queryParams = this.buildYamlParams(endpoint.queryParams);
    }

    // ボディパラメータ（存在する場合のみ）
    if (endpoint.bodyParams.length > 0) {
      result.bodyParams = this.buildYamlParams(endpoint.bodyParams);
    }

    // 認証必須フラグ
    result.requiresAuth = endpoint.requiresAuth;

    return result as YamlEndpoint;
  }

  /**
   * パラメータ配列をYAML用オブジェクトに変換
   */
  private buildYamlParams(params: readonly ParamInfo[]): YamlParams {
    const result: Record<string, string> = {};

    params.forEach(param => {
      // オプショナルの場合は " | undefined" を付加
      const typeStr = param.required
        ? param.type
        : `${param.type} | undefined`;
      result[param.name] = typeStr;
    });

    return result;
  }
}
```

---

## 出力オプション

### 拡張オプション型

```typescript
// src/types/options.ts に追加

export type OutputOptions = {
  /** メタ情報を含めるか */
  readonly includeMeta?: boolean;
  /** 認証情報を含めるか */
  readonly includeAuth?: boolean;
  /** ソースファイル情報を含めるか */
  readonly includeSourceInfo?: boolean;
  /** インデント幅 */
  readonly indent?: number;
};
```

### 拡張実装

```typescript
// src/generators/yamlGenerator.ts に追加

export class YamlGenerator {
  private options: OutputOptions;

  constructor(options: OutputOptions = {}) {
    this.options = {
      includeMeta: true,
      includeAuth: true,
      includeSourceInfo: false,
      indent: 2,
      ...options,
    };
  }

  generate(data: ExtractedEndpoints): string {
    const output = this.buildYamlOutput(data);
    return YAML.stringify(output, {
      indent: this.options.indent,
      lineWidth: 0,
    });
  }

  private buildYamlEndpoint(endpoint: EndpointInfo): YamlEndpoint {
    const result: Record<string, unknown> = {
      METHOD: endpoint.method,
    };

    // ... パラメータ処理 ...

    // オプションに応じて認証情報を含める
    if (this.options.includeAuth) {
      result.requiresAuth = endpoint.requiresAuth;
    }

    // オプションに応じてソース情報を含める
    if (this.options.includeSourceInfo) {
      result.source = {
        file: endpoint.sourceFile,
        line: endpoint.lineNumber,
      };
    }

    return result as YamlEndpoint;
  }
}
```

---

## ファイル出力

```typescript
// index.ts のCLI部分

async function main() {
  // ... 引数解析 ...

  const result = await extractEndpoints({ projectRoot, verbose });
  const generator = new YamlGenerator({
    includeMeta: true,
    includeAuth: true,
  });
  const yaml = generator.generate(result);

  if (outputFile) {
    await Bun.write(outputFile, yaml);
    console.log(`Output written to: ${outputFile}`);
  } else {
    console.log(yaml);
  }
}
```

---

## 出力例（完全版）

voice-app-test/serverプロジェクトの期待される出力:

```yaml
_meta:
  projectRoot: /Users/issei/program/ts_work/web/react/voice-app-test/server
  buildFile: src/build.ts
  extractedAt: "2025-12-29T12:00:00.000Z"
  totalEndpoints: 47

/users:
  endpoints:
    /exists/:uid:
      METHOD: GET
      pathParams:
        uid: string
      requiresAuth: false
    /initialize:
      METHOD: POST
      bodyParams:
        uid: string
        code: string | undefined
        forceRegister: boolean | undefined
        tokenType: "'token' | 'spotToken' | undefined"
      requiresAuth: false
    /collect:
      METHOD: POST
      bodyParams:
        id: string | undefined
        displayName: string | undefined
        email: string | undefined
        code: string | undefined
      requiresAuth: true
    /collectUser:
      METHOD: POST
      bodyParams:
        code: string | undefined
      requiresAuth: true
    /updateProfile:
      METHOD: POST
      bodyParams:
        displayName: string | undefined
        description: string | undefined
        icon: string | undefined
      requiresAuth: true
    /:id:
      METHOD: GET
      pathParams:
        id: string
      requiresAuth: true
    /:id:
      METHOD: PUT
      pathParams:
        id: string
      bodyParams:
        displayName: string | undefined
        description: string | undefined
      requiresAuth: true
    /:id:
      METHOD: DELETE
      pathParams:
        id: string
      requiresAuth: true
    /getUser/:id:
      METHOD: GET
      pathParams:
        id: string
      requiresAuth: true
    /deleteUser/:id:
      METHOD: DELETE
      pathParams:
        id: string
      requiresAuth: true
    /uninvited:
      METHOD: DELETE
      bodyParams:
        id: string
      requiresAuth: false
    /followers:
      METHOD: GET
      queryParams:
        id: string
        next: string | undefined
      requiresAuth: true
    /followings:
      METHOD: GET
      queryParams:
        id: string
        next: string | undefined
      requiresAuth: true
    /:id/block:
      METHOD: POST
      pathParams:
        id: string
      requiresAuth: true
    /:id/unblock:
      METHOD: POST
      pathParams:
        id: string
      requiresAuth: true
    /:userId/icon:
      METHOD: GET
      pathParams:
        userId: string
      requiresAuth: false
    /profileVisits:
      METHOD: GET
      queryParams:
        offset: string | undefined
        limit: string | undefined
      requiresAuth: true

/getRooms:
  endpoints:
    /:
      METHOD: GET
      queryParams:
        name: string | undefined
        roomId: string | undefined
      requiresAuth: true

/musics:
  endpoints:
    # ... musicsルートのエンドポイント

/room:
  endpoints:
    # ... roomルートのエンドポイント

# ... 他のルート
```

---

## 注意事項

1. **同一パス・異なるメソッド**: 同じパスで異なるHTTPメソッドを持つ場合、YAMLの仕様上キーが重複するため、メソッドをパスに含める形式に変更する可能性がある

2. **特殊文字のエスケープ**: パスに特殊文字（`:`など）が含まれる場合、YAML出力時に適切にクォートされる

3. **大規模プロジェクト**: エンドポイント数が多い場合、出力ファイルサイズに注意
