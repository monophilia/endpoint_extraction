# NestJS エンドポイント抽出機能

Updated: 2025/12/30 22:20

## 概要

NestJSプロジェクトからエンドポイント情報を抽出する機能を実装する。
既存のFastify実装パターンに準拠し、同一のEndpointInfo型を出力する。

### 主な特徴

- **AuthGuard継承の自動検出**: プロジェクト固有のガード名に依存せず、`AuthGuard`を継承しているクラスを自動検出
- **設定ファイルサポート**: YAML/JSON形式の設定ファイルで認証ガードやパブリックデコレーターをカスタマイズ可能
- **判定確信度の出力**: 認証判定の確信度（high/medium/low）を出力し、不確実な判定を明示

## 目次

1. [タスクリスト](./01.tasks.md) - 実装タスク一覧（18タスク）
2. [モデル設計](./02.models.md) - NestJS固有の型定義
3. [テスト設計](./03.tests.md) - テストケース定義
4. [パーサー実装](./04.parser-implementation.md) - AST解析ロジック
5. [設定ファイル設計](./05.config-file.md) - 設定ファイルの仕様と実装
6. [調査結果](./00.research.md) - NestJS認証機構の調査結果
7. [レビューチェックリスト](./99.review-checklist.md) - 品質保証（41観点）

## スコープ

### 対象

- `@Controller()` デコレーターによるルーティング
- HTTPメソッドデコレーター（`@Get`, `@Post`, `@Put`, `@Delete`, `@Patch`）
- パラメーターデコレーター（`@Param`, `@Body`, `@Query`）
- 認証デコレーター（`@UseGuards`, `@Public`）
- モジュール構造の解析（`app.module.ts`からのコントローラー検出）

### 対象外

- GraphQLリゾルバー
- WebSocketゲートウェイ
- マイクロサービス
- カスタムトランスポート

## 前提条件

- 既存のEndpointInfo型を再利用
- Fastify実装と同一のExtractorOptionsを使用
- ts-morphによるAST解析

## 依存関係

- ts-morph（既存）
- 既存の型定義（EndpointInfo, AuthInfo, ParamInfo等）

## アーキテクチャ

```
src/
├── types/
│   ├── nestjs.ts             # NestJS固有の型定義
│   ├── config.ts             # 設定ファイル型定義
│   └── index.ts              # エクスポート
├── config/
│   ├── loader.ts             # 設定ファイル読み込み
│   └── defaults.ts           # デフォルト設定値
├── extractors/
│   ├── fastify/              # 既存
│   │   ├── index.ts
│   │   ├── buildFileParser.ts
│   │   ├── routeFileParser.ts
│   │   ├── authDetector.ts
│   │   └── responseExtractor.ts
│   ├── nestjs/               # 新規
│   │   ├── index.ts              # NestJSExtractor
│   │   ├── moduleParser.ts       # app.module.ts解析
│   │   ├── controllerParser.ts   # コントローラー解析
│   │   ├── decoratorParser.ts    # デコレーター解析
│   │   ├── guardAnalyzer.ts      # ガード解析・継承検出
│   │   └── authDetector.ts       # 認証検出
│   └── types.ts              # 共通インターフェース
└── index.ts                  # CLI
```

## 実装フェーズ

| Phase | 内容 | 担当設計書 | 並列可否 | タスク数 |
|-------|------|-----------|---------|---------|
| 1 | 型定義・設定・インターフェース | 02.models.md, 05.config-file.md | Yes | 5 |
| 2 | テスト作成（TDD Red） | 03.tests.md | Yes | 5 |
| 3 | ConfigLoader・GuardAnalyzer実装 | 04.parser-implementation.md, 05.config-file.md | Yes | 2 |
| 4 | パーサー実装 | 04.parser-implementation.md | Yes | 4 |
| 5 | NestJSExtractor統合 | 04.parser-implementation.md | - | 1 |
| 6 | CLI対応 | 05.config-file.md | - | 1 |

## Fastifyとの主な違い

| 観点 | Fastify | NestJS |
|------|---------|--------|
| ルート定義 | `server.get('/path', handler)` | `@Get('path')` デコレーター |
| パラメーター | ジェネリック型 `<{Params: ...}>` | `@Param()`, `@Body()`, `@Query()` |
| 認証 | `preHandler` フック | `@UseGuards()` デコレーター |
| 公開ルート | 特定ミドルウェア除外 | `@Public()` + `SetMetadata` |
| エントリーポイント | `build.ts` | `app.module.ts` |
