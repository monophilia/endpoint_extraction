# NestJS エンドポイント抽出 - 調査結果

## 調査日
2025-12-30

---

## 検証済み情報

### 1. コントローラーとルーティング

NestJSではデコレーターベースでルーティングを定義する。

#### 基本構造

```typescript
import { Controller, Get, Post, Put, Delete, Param, Body, Query } from '@nestjs/common';

@Controller('cats')  // プレフィックス: /cats
export class CatsController {
  @Get()           // GET /cats
  findAll() {}

  @Get(':id')      // GET /cats/:id
  findOne(@Param('id') id: string) {}

  @Post()          // POST /cats
  create(@Body() createCatDto: CreateCatDto) {}

  @Put(':id')      // PUT /cats/:id
  update(@Param('id') id: string, @Body() updateCatDto: UpdateCatDto) {}

  @Delete(':id')   // DELETE /cats/:id
  remove(@Param('id') id: string) {}
}
```

#### HTTPメソッドデコレーター

| デコレーター | HTTPメソッド |
|-------------|-------------|
| `@Get()` | GET |
| `@Post()` | POST |
| `@Put()` | PUT |
| `@Delete()` | DELETE |
| `@Patch()` | PATCH |
| `@Options()` | OPTIONS |
| `@Head()` | HEAD |
| `@All()` | 全メソッド |

#### パラメーターデコレーター

| デコレーター | 用途 | 例 |
|-------------|------|-----|
| `@Param()` | パスパラメーター | `@Param('id') id: string` |
| `@Body()` | リクエストボディ | `@Body() dto: CreateDto` |
| `@Query()` | クエリパラメーター | `@Query('page') page: number` |
| `@Headers()` | リクエストヘッダー | `@Headers('authorization') auth: string` |

**情報源:**
- [NestJS Controllers Documentation](https://docs.nestjs.com/controllers)
- [Context7 - NestJS docs.nestjs.com](https://github.com/nestjs/docs.nestjs.com/blob/master/content/controllers.md)

---

### 2. Guards（認証ガード）

Guardsはリクエストが処理される前に実行され、アクセス制御を行う。

#### 基本構造

```typescript
import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';

@Injectable()
export class AuthGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean | Promise<boolean> {
    const request = context.switchToHttp().getRequest();
    return validateRequest(request);
  }
}
```

#### JWT認証ガード実装例

```typescript
import { CanActivate, ExecutionContext, Injectable, UnauthorizedException } from '@nestjs/common';
import { JwtService } from '@nestjs/jwt';
import { Request } from 'express';

@Injectable()
export class AuthGuard implements CanActivate {
  constructor(private jwtService: JwtService) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest();
    const token = this.extractTokenFromHeader(request);
    if (!token) {
      throw new UnauthorizedException();
    }
    try {
      const payload = await this.jwtService.verifyAsync(token, {
        secret: jwtConstants.secret
      });
      request['user'] = payload;
    } catch {
      throw new UnauthorizedException();
    }
    return true;
  }

  private extractTokenFromHeader(request: Request): string | undefined {
    const [type, token] = request.headers.authorization?.split(' ') ?? [];
    return type === 'Bearer' ? token : undefined;
  }
}
```

**情報源:**
- [NestJS Guards Documentation](https://docs.nestjs.com/guards)
- [NestJS Authentication Documentation](https://docs.nestjs.com/security/authentication)

---

### 3. @UseGuards デコレーター

ガードの適用方法は3つある。

#### コントローラーレベル

```typescript
@Controller('cats')
@UseGuards(AuthGuard)  // 全メソッドに適用
export class CatsController {}
```

#### メソッドレベル

```typescript
@Controller('cats')
export class CatsController {
  @Get()
  @UseGuards(AuthGuard)  // このメソッドのみに適用
  findAll() {}
}
```

#### グローバルレベル（APP_GUARD）

```typescript
// app.module.ts
import { Module } from '@nestjs/common';
import { APP_GUARD } from '@nestjs/core';

@Module({
  providers: [
    {
      provide: APP_GUARD,
      useClass: AuthGuard,
    },
  ],
})
export class AppModule {}
```

**重要**: `APP_GUARD`で登録したガードは全てのエンドポイントに適用される。特定ルートを除外するには`@Public()`デコレーターを使用する。

**情報源:**
- [NestJS Guards Documentation](https://docs.nestjs.com/guards)
- [DigitalOcean - Understanding Guards in NestJS](https://www.digitalocean.com/community/tutorials/understanding-guards-in-nestjs)

---

### 4. カスタムデコレーター

#### @Public デコレーター

グローバルガードから特定ルートを除外するために使用。

```typescript
// public.decorator.ts
import { SetMetadata } from '@nestjs/common';

export const IS_PUBLIC_KEY = 'isPublic';
export const Public = () => SetMetadata(IS_PUBLIC_KEY, true);
```

#### @Roles デコレーター

ロールベースアクセス制御に使用。

```typescript
// roles.decorator.ts
import { SetMetadata } from '@nestjs/common';
import { Role } from '../enums/role.enum';

export const ROLES_KEY = 'roles';
export const Roles = (...roles: Role[]) => SetMetadata(ROLES_KEY, roles);
```

#### 使用例

```typescript
@Controller('users')
export class UsersController {
  @Public()  // 認証不要
  @Get('public')
  publicRoute() {}

  @Roles(Role.Admin)  // Admin権限必須
  @Get('admin')
  adminRoute() {}
}
```

**情報源:**
- [NestJS Authentication Documentation](https://docs.nestjs.com/security/authentication)
- [NestJS Authorization Documentation](https://docs.nestjs.com/security/authorization)
- [Context7 - execution-context.md](https://github.com/nestjs/docs.nestjs.com/blob/master/content/fundamentals/execution-context.md)

---

### 5. Reflector によるメタデータ取得

ガード内でカスタムデコレーターのメタデータを取得する。

#### RolesGuard 実装例

```typescript
import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { Role } from '../enums/role.enum';
import { ROLES_KEY } from '../decorators/roles.decorator';

@Injectable()
export class RolesGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(context: ExecutionContext): boolean {
    const requiredRoles = this.reflector.getAllAndOverride<Role[]>(ROLES_KEY, [
      context.getHandler(),  // メソッドレベルのメタデータ
      context.getClass(),    // クラスレベルのメタデータ
    ]);
    if (!requiredRoles) {
      return true;  // ロール指定なし = アクセス許可
    }
    const { user } = context.switchToHttp().getRequest();
    return requiredRoles.some((role) => user.roles?.includes(role));
  }
}
```

#### AuthGuard での @Public チェック

```typescript
@Injectable()
export class AuthGuard implements CanActivate {
  constructor(
    private jwtService: JwtService,
    private reflector: Reflector,
  ) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    // @Public() チェック
    const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [
      context.getHandler(),
      context.getClass(),
    ]);
    if (isPublic) {
      return true;  // 公開ルート
    }
    // JWT検証処理...
  }
}
```

**情報源:**
- [NestJS Authorization Documentation](https://docs.nestjs.com/security/authorization)
- [Trilon - NestJS Metadata Deep Dive](https://trilon.io/blog/nestjs-metadata-deep-dive)

---

### 6. ExecutionContext

ガード・インターセプター内でリクエスト情報にアクセスするためのインターフェース。

```typescript
export interface ExecutionContext extends ArgumentsHost {
  getClass<T>(): Type<T>;      // コントローラークラスを取得
  getHandler(): Function;       // ハンドラーメソッドを取得
}
```

#### HTTPリクエスト取得

```typescript
const request = context.switchToHttp().getRequest();
const response = context.switchToHttp().getResponse();
```

**情報源:**
- [NestJS Execution Context Documentation](https://docs.nestjs.com/fundamentals/execution-context)

---

## エンドポイント抽出に必要なAST解析パターン

### 1. 検出すべきデコレーター

| カテゴリ | デコレーター | 抽出情報 |
|---------|-------------|---------|
| ルーティング | `@Controller('path')` | ベースパス |
| HTTPメソッド | `@Get()`, `@Post()`, `@Put()`, `@Delete()`, `@Patch()` | メソッド、サブパス |
| パラメーター | `@Param()`, `@Body()`, `@Query()` | パラメーター情報 |
| 認証 | `@UseGuards()` | ガード名 |
| 公開 | `@Public()` | 認証除外フラグ |
| 権限 | `@Roles()` | 必要ロール |

### 2. 認証判定ロジック

```
認証必須 = (
  (@UseGuards にAuthGuard系が含まれる) OR
  (APP_GUARD でAuthGuardがグローバル登録)
) AND NOT (@Public() が付与)
```

### 3. 一般的な認証ガード名パターン

- `AuthGuard`
- `JwtAuthGuard`
- `JwtGuard`
- `TokenGuard`
- `AuthenticationGuard`
- `SessionGuard`
- `PassportAuthGuard`

### 4. 一般的なカスタムデコレーター

| デコレーター | メタデータキー | 用途 |
|-------------|---------------|------|
| `@Public()` | `isPublic` / `IS_PUBLIC_KEY` | 認証除外 |
| `@Roles()` | `roles` / `ROLES_KEY` | ロール制限 |
| `@Permissions()` | `permissions` | 権限制限 |
| `@Auth()` | 複合 | 認証+権限 |

---

## 調査ソース一覧

| ソース種別 | 検索クエリ/ライブラリ | 結果概要 |
|-----------|---------------------|---------|
| WebSearch | NestJS authentication guards decorators | Guards、@UseGuards、@Publicの基本パターン |
| WebSearch | NestJS controller decorators routing | コントローラー、HTTPメソッドデコレーター |
| WebSearch | NestJS SetMetadata Reflector | カスタムデコレーター実装パターン |
| WebSearch | NestJS APP_GUARD global guard | グローバルガード登録方法 |
| Context7 | /nestjs/docs.nestjs.com - Guards | CanActivate、ExecutionContext |
| Context7 | /nestjs/docs.nestjs.com - Controllers | CRUD、パラメーターデコレーター |
| Context7 | /nestjs/docs.nestjs.com - SetMetadata | Roles、Publicデコレーター |

---

## 未検証・要確認事項

- Passport.js統合時の`AuthGuard('jwt')`パターンの詳細
- GraphQL用ガード（GqlExecutionContext）の扱い
- マイクロサービス/WebSocket用ガードの扱い
- `@nestjs/passport`の`AuthGuard`と自前実装の違い
