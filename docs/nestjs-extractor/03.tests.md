# テスト設計: NestJS エンドポイント抽出

Updated: 2025/12/30 22:00

## 目的

TDD原則に従い、実装前にテストケースを定義する。
テストは実装より先に作成し、FAILすることを確認してから実装を進める。

---

## テストフィクスチャ

### ファイル: `src/__tests__/fixtures/nestjs.fixture.ts`

```typescript
// 基本的なコントローラー
export const BASIC_CONTROLLER_FIXTURE = `
import { Controller, Get, Post, Param, Body, Query } from '@nestjs/common';

@Controller('users')
export class UsersController {
  @Get()
  findAll() {
    return [];
  }

  @Get(':id')
  findOne(@Param('id') id: string) {
    return { id };
  }

  @Post()
  create(@Body() createUserDto: CreateUserDto) {
    return createUserDto;
  }

  @Get('search')
  search(@Query('name') name: string, @Query('age') age?: number) {
    return { name, age };
  }
}

interface CreateUserDto {
  name: string;
  email: string;
}
`;

// 認証付きコントローラー
export const AUTH_CONTROLLER_FIXTURE = `
import { Controller, Get, UseGuards } from '@nestjs/common';
import { AuthGuard } from './auth.guard';

@Controller('protected')
@UseGuards(AuthGuard)
export class ProtectedController {
  @Get()
  getProtected() {
    return { message: 'protected' };
  }
}
`;

// Publicデコレーター付きコントローラー
export const PUBLIC_ROUTE_FIXTURE = `
import { Controller, Get, UseGuards } from '@nestjs/common';
import { AuthGuard } from './auth.guard';
import { Public } from './public.decorator';

@Controller('mixed')
@UseGuards(AuthGuard)
export class MixedController {
  @Get('private')
  privateRoute() {
    return { access: 'private' };
  }

  @Public()
  @Get('public')
  publicRoute() {
    return { access: 'public' };
  }
}
`;

// メソッドレベルガード
export const METHOD_GUARD_FIXTURE = `
import { Controller, Get, Post, UseGuards } from '@nestjs/common';
import { AuthGuard } from './auth.guard';

@Controller('partial')
export class PartialController {
  @Get()
  publicGet() {
    return { public: true };
  }

  @Post()
  @UseGuards(AuthGuard)
  protectedPost() {
    return { protected: true };
  }
}
`;

// Rolesデコレーター付き
export const ROLES_FIXTURE = `
import { Controller, Get, UseGuards } from '@nestjs/common';
import { AuthGuard } from './auth.guard';
import { RolesGuard } from './roles.guard';
import { Roles } from './roles.decorator';

@Controller('admin')
@UseGuards(AuthGuard, RolesGuard)
export class AdminController {
  @Get()
  @Roles('admin')
  adminOnly() {
    return { role: 'admin' };
  }

  @Get('moderator')
  @Roles('admin', 'moderator')
  moderatorAccess() {
    return { roles: ['admin', 'moderator'] };
  }
}
`;

// モジュール定義
export const MODULE_FIXTURE = `
import { Module } from '@nestjs/common';
import { APP_GUARD } from '@nestjs/core';
import { UsersController } from './users.controller';
import { AuthController } from './auth.controller';
import { AuthGuard } from './auth.guard';

@Module({
  controllers: [UsersController, AuthController],
  providers: [
    {
      provide: APP_GUARD,
      useClass: AuthGuard,
    },
  ],
})
export class AppModule {}
`;

// グローバルガードなしモジュール
export const MODULE_NO_GUARD_FIXTURE = `
import { Module } from '@nestjs/common';
import { UsersController } from './users.controller';

@Module({
  controllers: [UsersController],
})
export class AppModule {}
`;

// 複数パスパラメーター
export const MULTIPLE_PARAMS_FIXTURE = `
import { Controller, Get, Param } from '@nestjs/common';

@Controller('groups/:groupId/users')
export class GroupUsersController {
  @Get(':userId')
  getUser(
    @Param('groupId') groupId: string,
    @Param('userId') userId: string,
  ) {
    return { groupId, userId };
  }
}
`;

// ネストされたパス
export const NESTED_PATH_FIXTURE = `
import { Controller, Get, Post, Put, Delete } from '@nestjs/common';

@Controller('api/v1/resources')
export class ResourcesController {
  @Get()
  list() {}

  @Get(':id')
  get() {}

  @Post()
  create() {}

  @Put(':id')
  update() {}

  @Delete(':id')
  delete() {}
}
`;
```

---

## DecoratorParser テスト

### ファイル: `src/__tests__/nestjs/decoratorParser.test.ts`

```typescript
import { describe, it, expect, beforeEach } from 'bun:test';
import { Project } from 'ts-morph';
import { DecoratorParser } from '../../extractors/nestjs/decoratorParser';
import { BASIC_CONTROLLER_FIXTURE } from '../fixtures/nestjs.fixture';

describe('DecoratorParser', () => {
  let project: Project;
  let parser: DecoratorParser;

  beforeEach(() => {
    project = new Project({ useInMemoryFileSystem: true });
    parser = new DecoratorParser();
  });

  describe('parseMethodDecorators', () => {
    it('@Get()デコレーターを検出する', () => {
      const sourceFile = project.createSourceFile('test.ts', BASIC_CONTROLLER_FIXTURE);
      const classDecl = sourceFile.getClasses()[0];
      const method = classDecl.getMethod('findAll')!;

      const result = parser.parseMethodDecorator(method);

      expect(result).toBeDefined();
      expect(result?.type).toBe('Get');
      expect(result?.path).toBe('');
    });

    it('@Get(\':id\')のパスを抽出する', () => {
      const sourceFile = project.createSourceFile('test.ts', BASIC_CONTROLLER_FIXTURE);
      const classDecl = sourceFile.getClasses()[0];
      const method = classDecl.getMethod('findOne')!;

      const result = parser.parseMethodDecorator(method);

      expect(result).toBeDefined();
      expect(result?.type).toBe('Get');
      expect(result?.path).toBe(':id');
    });

    it('@Post()デコレーターを検出する', () => {
      const sourceFile = project.createSourceFile('test.ts', BASIC_CONTROLLER_FIXTURE);
      const classDecl = sourceFile.getClasses()[0];
      const method = classDecl.getMethod('create')!;

      const result = parser.parseMethodDecorator(method);

      expect(result).toBeDefined();
      expect(result?.type).toBe('Post');
    });

    it('HTTPメソッドデコレーターがないメソッドはnullを返す', () => {
      const sourceFile = project.createSourceFile('test.ts', `
        class NoDecorator {
          normalMethod() {}
        }
      `);
      const classDecl = sourceFile.getClasses()[0];
      const method = classDecl.getMethod('normalMethod')!;

      const result = parser.parseMethodDecorator(method);

      expect(result).toBeNull();
    });
  });

  describe('parseParamDecorators', () => {
    it('@Param()デコレーターを検出する', () => {
      const sourceFile = project.createSourceFile('test.ts', BASIC_CONTROLLER_FIXTURE);
      const classDecl = sourceFile.getClasses()[0];
      const method = classDecl.getMethod('findOne')!;

      const result = parser.parseParamDecorators(method);

      expect(result).toHaveLength(1);
      expect(result[0].type).toBe('Param');
      expect(result[0].argName).toBe('id');
      expect(result[0].paramName).toBe('id');
      expect(result[0].paramType).toBe('string');
    });

    it('@Body()デコレーターを検出する', () => {
      const sourceFile = project.createSourceFile('test.ts', BASIC_CONTROLLER_FIXTURE);
      const classDecl = sourceFile.getClasses()[0];
      const method = classDecl.getMethod('create')!;

      const result = parser.parseParamDecorators(method);

      expect(result).toHaveLength(1);
      expect(result[0].type).toBe('Body');
      expect(result[0].paramName).toBe('createUserDto');
    });

    it('@Query()デコレーターを検出する', () => {
      const sourceFile = project.createSourceFile('test.ts', BASIC_CONTROLLER_FIXTURE);
      const classDecl = sourceFile.getClasses()[0];
      const method = classDecl.getMethod('search')!;

      const result = parser.parseParamDecorators(method);

      expect(result).toHaveLength(2);
      expect(result[0].type).toBe('Query');
      expect(result[0].argName).toBe('name');
      expect(result[0].required).toBe(true);
      expect(result[1].argName).toBe('age');
      expect(result[1].required).toBe(false);
    });

    it('複数の@Param()を検出する', () => {
      const sourceFile = project.createSourceFile('test.ts', `
        import { Controller, Get, Param } from '@nestjs/common';

        @Controller('groups/:groupId/users')
        export class GroupUsersController {
          @Get(':userId')
          getUser(
            @Param('groupId') groupId: string,
            @Param('userId') userId: string,
          ) {}
        }
      `);
      const classDecl = sourceFile.getClasses()[0];
      const method = classDecl.getMethods()[0];

      const result = parser.parseParamDecorators(method);

      expect(result).toHaveLength(2);
      expect(result[0].argName).toBe('groupId');
      expect(result[1].argName).toBe('userId');
    });
  });

  describe('parseGuardDecorators', () => {
    it('@UseGuards(AuthGuard)を検出する', () => {
      const sourceFile = project.createSourceFile('test.ts', `
        import { Controller, Get, UseGuards } from '@nestjs/common';
        import { AuthGuard } from './auth.guard';

        @Controller('test')
        export class TestController {
          @Get()
          @UseGuards(AuthGuard)
          protected() {}
        }
      `);
      const classDecl = sourceFile.getClasses()[0];
      const method = classDecl.getMethods()[0];

      const result = parser.parseGuardDecorators(method);

      expect(result).toHaveLength(1);
      expect(result[0].guards).toContain('AuthGuard');
      expect(result[0].level).toBe('method');
    });

    it('複数ガードを検出する', () => {
      const sourceFile = project.createSourceFile('test.ts', `
        import { Controller, Get, UseGuards } from '@nestjs/common';

        @Controller('test')
        export class TestController {
          @Get()
          @UseGuards(AuthGuard, RolesGuard)
          protected() {}
        }
      `);
      const classDecl = sourceFile.getClasses()[0];
      const method = classDecl.getMethods()[0];

      const result = parser.parseGuardDecorators(method);

      expect(result).toHaveLength(1);
      expect(result[0].guards).toContain('AuthGuard');
      expect(result[0].guards).toContain('RolesGuard');
    });
  });

  describe('parseMetadataDecorators', () => {
    it('@Public()デコレーターを検出する', () => {
      const sourceFile = project.createSourceFile('test.ts', `
        import { Controller, Get } from '@nestjs/common';
        import { Public } from './public.decorator';

        @Controller('test')
        export class TestController {
          @Public()
          @Get()
          publicRoute() {}
        }
      `);
      const classDecl = sourceFile.getClasses()[0];
      const method = classDecl.getMethods()[0];

      const result = parser.parseMetadataDecorators(method, ['Public']);

      expect(result).toHaveLength(1);
      expect(result[0].name).toBe('Public');
    });

    it('@Roles()デコレーターの値を抽出する', () => {
      const sourceFile = project.createSourceFile('test.ts', `
        import { Controller, Get } from '@nestjs/common';
        import { Roles } from './roles.decorator';

        @Controller('test')
        export class TestController {
          @Roles('admin', 'moderator')
          @Get()
          adminRoute() {}
        }
      `);
      const classDecl = sourceFile.getClasses()[0];
      const method = classDecl.getMethods()[0];

      const result = parser.parseMetadataDecorators(method, ['Roles']);

      expect(result).toHaveLength(1);
      expect(result[0].name).toBe('Roles');
      expect(result[0].value).toEqual(['admin', 'moderator']);
    });
  });
});
```

---

## ControllerParser テスト

### ファイル: `src/__tests__/nestjs/controllerParser.test.ts`

```typescript
import { describe, it, expect, beforeEach } from 'bun:test';
import { Project } from 'ts-morph';
import { ControllerParser } from '../../extractors/nestjs/controllerParser';
import {
  BASIC_CONTROLLER_FIXTURE,
  AUTH_CONTROLLER_FIXTURE,
  PUBLIC_ROUTE_FIXTURE,
  NESTED_PATH_FIXTURE,
} from '../fixtures/nestjs.fixture';

describe('ControllerParser', () => {
  let project: Project;
  let parser: ControllerParser;

  beforeEach(() => {
    project = new Project({ useInMemoryFileSystem: true });
    parser = new ControllerParser();
  });

  describe('parseController', () => {
    it('コントローラーのベースパスを抽出する', () => {
      const sourceFile = project.createSourceFile('users.controller.ts', BASIC_CONTROLLER_FIXTURE);

      const result = parser.parseController(sourceFile);

      expect(result).toBeDefined();
      expect(result?.basePath).toBe('users');
      expect(result?.name).toBe('UsersController');
    });

    it('ネストされたパスを抽出する', () => {
      const sourceFile = project.createSourceFile('resources.controller.ts', NESTED_PATH_FIXTURE);

      const result = parser.parseController(sourceFile);

      expect(result?.basePath).toBe('api/v1/resources');
    });

    it('メソッド一覧を抽出する', () => {
      const sourceFile = project.createSourceFile('users.controller.ts', BASIC_CONTROLLER_FIXTURE);

      const result = parser.parseController(sourceFile);

      expect(result?.methods).toHaveLength(4);
      expect(result?.methods.map(m => m.name)).toEqual([
        'findAll', 'findOne', 'create', 'search'
      ]);
    });

    it('クラスレベルの@UseGuardsを抽出する', () => {
      const sourceFile = project.createSourceFile('protected.controller.ts', AUTH_CONTROLLER_FIXTURE);

      const result = parser.parseController(sourceFile);

      expect(result?.classGuards).toHaveLength(1);
      expect(result?.classGuards[0].guards).toContain('AuthGuard');
    });
  });

  describe('extractEndpoints', () => {
    it('全エンドポイントをEndpointInfo形式で抽出する', () => {
      const sourceFile = project.createSourceFile('users.controller.ts', BASIC_CONTROLLER_FIXTURE);
      const controller = parser.parseController(sourceFile)!;

      const endpoints = parser.extractEndpoints(controller, []);

      expect(endpoints).toHaveLength(4);

      // GET /users
      expect(endpoints[0].path).toBe('/users');
      expect(endpoints[0].method).toBe('GET');

      // GET /users/:id
      expect(endpoints[1].path).toBe('/users/:id');
      expect(endpoints[1].method).toBe('GET');
      expect(endpoints[1].pathParams).toHaveLength(1);

      // POST /users
      expect(endpoints[2].path).toBe('/users');
      expect(endpoints[2].method).toBe('POST');
      expect(endpoints[2].bodyParams.length).toBeGreaterThan(0);

      // GET /users/search
      expect(endpoints[3].path).toBe('/users/search');
      expect(endpoints[3].queryParams).toHaveLength(2);
    });

    it('パスを正しく結合する', () => {
      const sourceFile = project.createSourceFile('resources.controller.ts', NESTED_PATH_FIXTURE);
      const controller = parser.parseController(sourceFile)!;

      const endpoints = parser.extractEndpoints(controller, []);

      expect(endpoints[0].path).toBe('/api/v1/resources');
      expect(endpoints[1].path).toBe('/api/v1/resources/:id');
    });
  });
});
```

---

## ModuleParser テスト

### ファイル: `src/__tests__/nestjs/moduleParser.test.ts`

```typescript
import { describe, it, expect, beforeEach } from 'bun:test';
import { Project } from 'ts-morph';
import { ModuleParser } from '../../extractors/nestjs/moduleParser';
import {
  MODULE_FIXTURE,
  MODULE_NO_GUARD_FIXTURE,
} from '../fixtures/nestjs.fixture';

describe('ModuleParser', () => {
  let project: Project;
  let parser: ModuleParser;

  beforeEach(() => {
    project = new Project({ useInMemoryFileSystem: true });
    parser = new ModuleParser();
  });

  describe('parseModule', () => {
    it('コントローラー登録を検出する', () => {
      const sourceFile = project.createSourceFile('app.module.ts', MODULE_FIXTURE);

      const result = parser.parseModule(sourceFile);

      expect(result.controllers).toHaveLength(2);
      expect(result.controllers.map(c => c.name)).toEqual([
        'UsersController', 'AuthController'
      ]);
    });

    it('APP_GUARDを検出する', () => {
      const sourceFile = project.createSourceFile('app.module.ts', MODULE_FIXTURE);

      const result = parser.parseModule(sourceFile);

      expect(result.globalGuards).toHaveLength(1);
      expect(result.globalGuards[0]).toBe('AuthGuard');
    });

    it('APP_GUARDがない場合は空配列を返す', () => {
      const sourceFile = project.createSourceFile('app.module.ts', MODULE_NO_GUARD_FIXTURE);

      const result = parser.parseModule(sourceFile);

      expect(result.globalGuards).toHaveLength(0);
    });

    it('コントローラーのインポートパスを解決する', () => {
      const sourceFile = project.createSourceFile('app.module.ts', MODULE_FIXTURE);

      const result = parser.parseModule(sourceFile);

      expect(result.controllers[0].importPath).toBe('./users.controller');
    });
  });
});
```

---

## AuthDetector テスト

### ファイル: `src/__tests__/nestjs/authDetector.test.ts`

```typescript
import { describe, it, expect, beforeEach } from 'bun:test';
import { Project } from 'ts-morph';
import { NestJSAuthDetector } from '../../extractors/nestjs/authDetector';
import { ControllerParser } from '../../extractors/nestjs/controllerParser';
import {
  BASIC_CONTROLLER_FIXTURE,
  AUTH_CONTROLLER_FIXTURE,
  PUBLIC_ROUTE_FIXTURE,
  METHOD_GUARD_FIXTURE,
} from '../fixtures/nestjs.fixture';
import { DEFAULT_NESTJS_AUTH_CONFIG } from '../../types';

describe('NestJSAuthDetector', () => {
  let project: Project;
  let detector: NestJSAuthDetector;
  let controllerParser: ControllerParser;

  beforeEach(() => {
    project = new Project({ useInMemoryFileSystem: true });
    detector = new NestJSAuthDetector(DEFAULT_NESTJS_AUTH_CONFIG);
    controllerParser = new ControllerParser();
  });

  describe('detectAuth', () => {
    it('認証なしコントローラーはrequired: falseを返す', () => {
      const sourceFile = project.createSourceFile('test.ts', BASIC_CONTROLLER_FIXTURE);
      const controller = controllerParser.parseController(sourceFile)!;
      const method = controller.methods[0];

      const result = detector.detectAuth(controller, method, []);

      expect(result.required).toBe(false);
    });

    it('クラスレベル@UseGuards付きはrequired: trueを返す', () => {
      const sourceFile = project.createSourceFile('test.ts', AUTH_CONTROLLER_FIXTURE);
      const controller = controllerParser.parseController(sourceFile)!;
      const method = controller.methods[0];

      const result = detector.detectAuth(controller, method, []);

      expect(result.required).toBe(true);
      expect(result.guards).toContain('AuthGuard');
    });

    it('@Public()付きメソッドはrequired: falseを返す', () => {
      const sourceFile = project.createSourceFile('test.ts', PUBLIC_ROUTE_FIXTURE);
      const controller = controllerParser.parseController(sourceFile)!;
      const publicMethod = controller.methods.find(m => m.name === 'publicRoute')!;

      const result = detector.detectAuth(controller, publicMethod, []);

      expect(result.required).toBe(false);
    });

    it('メソッドレベル@UseGuards付きはrequired: trueを返す', () => {
      const sourceFile = project.createSourceFile('test.ts', METHOD_GUARD_FIXTURE);
      const controller = controllerParser.parseController(sourceFile)!;
      const protectedMethod = controller.methods.find(m => m.name === 'protectedPost')!;

      const result = detector.detectAuth(controller, protectedMethod, []);

      expect(result.required).toBe(true);
    });

    it('グローバルガードがあればデフォルト認証必須', () => {
      const sourceFile = project.createSourceFile('test.ts', BASIC_CONTROLLER_FIXTURE);
      const controller = controllerParser.parseController(sourceFile)!;
      const method = controller.methods[0];

      const result = detector.detectAuth(controller, method, ['AuthGuard']);

      expect(result.required).toBe(true);
    });

    it('グローバルガード + @Publicで認証不要', () => {
      const sourceFile = project.createSourceFile('test.ts', PUBLIC_ROUTE_FIXTURE);
      const controller = controllerParser.parseController(sourceFile)!;
      const publicMethod = controller.methods.find(m => m.name === 'publicRoute')!;

      const result = detector.detectAuth(controller, publicMethod, ['AuthGuard']);

      expect(result.required).toBe(false);
    });
  });
});
```

---

## NestJSExtractor 統合テスト

### ファイル: `src/__tests__/nestjs/nestjsExtractor.test.ts`

```typescript
import { describe, it, expect } from 'bun:test';
import { NestJSExtractor } from '../../extractors/nestjs';

describe('NestJSExtractor', () => {
  describe('canHandle', () => {
    it('@nestjs/commonがあればtrueを返す', async () => {
      // 実際のNestJSプロジェクトでテスト
      // または、テスト用のpackage.jsonを作成
    });

    it('@nestjs/commonがなければfalseを返す', async () => {
      // Fastifyプロジェクト等でテスト
    });
  });

  describe('extract', () => {
    it('全エンドポイントを抽出する', async () => {
      // 統合テスト
    });

    it('認証情報を正しく判定する', async () => {
      // 統合テスト
    });
  });
});
```

---

## テスト実行順序

```
1. decoratorParser.test.ts
   - デコレーター解析の単体テスト

2. controllerParser.test.ts
   - コントローラー解析の単体テスト

3. moduleParser.test.ts
   - モジュール解析の単体テスト

4. authDetector.test.ts
   - 認証検出の単体テスト

5. nestjsExtractor.test.ts
   - 統合テスト
```
