# タスクリスト: NestJS エンドポイント抽出機能

Updated: 2025/12/30 22:20

## 復旧手順

このファイルを読み込んだ場合、以下を実行:
1. 下記のTodo一覧をTodoWriteで設定
2. in_progressのタスクから作業再開
3. 該当タスクの詳細セクションを参照

---

## 進捗サマリー

- **Phase 1**: pending (タスク1-5)
- **Phase 2**: pending (タスク6-10)
- **Phase 3**: pending (タスク11-18)
- **ブランチ**: `feature/nestjs-extractor`

---

## Todo一覧（TodoWrite用）

<!-- TodoWrite形式: content | status | activeForm -->
| # | タスク | Phase | 状態 | 進行形 |
|---|--------|-------|------|--------|
| 1 | NestJS固有の型を定義する | 1 | pending | NestJS固有の型を定義している |
| 2 | DecoratorInfo型を定義する | 1 | pending | DecoratorInfo型を定義している |
| 3 | 設定ファイル型を定義する | 1 | pending | 設定ファイル型を定義している |
| 4 | デフォルト設定値を定義する | 1 | pending | デフォルト設定値を定義している |
| 5 | NestJSExtractorインターフェースを実装する | 1 | pending | NestJSExtractorインターフェースを実装している |
| 6 | 設定ファイル読み込みテストを作成する | 2 | pending | 設定ファイル読み込みテストを作成している |
| 7 | デコレーターパーサー用テストを作成する | 2 | pending | デコレーターパーサー用テストを作成している |
| 8 | コントローラーパーサー用テストを作成する | 2 | pending | コントローラーパーサー用テストを作成している |
| 9 | モジュールパーサー用テストを作成する | 2 | pending | モジュールパーサー用テストを作成している |
| 10 | GuardAnalyzer用テストを作成する | 2 | pending | GuardAnalyzer用テストを作成している |
| 11 | ConfigLoaderを実装する | 3 | pending | ConfigLoaderを実装している |
| 12 | GuardAnalyzerを実装する | 3 | pending | GuardAnalyzerを実装している |
| 13 | decoratorParser.tsを実装する | 3 | pending | decoratorParser.tsを実装している |
| 14 | controllerParser.tsを実装する | 3 | pending | controllerParser.tsを実装している |
| 15 | authDetector.tsを実装する | 3 | pending | authDetector.tsを実装している |
| 16 | moduleParser.tsを実装する | 3 | pending | moduleParser.tsを実装している |
| 17 | NestJSExtractorを統合する | 3 | pending | NestJSExtractorを統合している |
| 18 | CLIに--configオプションを追加する | 3 | pending | CLIオプションを追加している |

---

## タスク詳細

### タスク1: NestJS固有の型を定義する

**状態**: pending
**Phase**: 1
**参照設計書**: [02.models.md](./02.models.md#nestjs固有型)

**作業内容**:
1. `src/types/nestjs.ts` を新規作成
2. ControllerInfo型を定義
3. MethodDecoratorType型を定義
4. GuardInfo型を定義

**担当ファイル**:
- `src/types/nestjs.ts`（新規）

**完了条件**:
- [ ] 全型が設計書と一致
- [ ] index.tsからエクスポートされている
- [ ] TypeScriptエラーがない

---

### タスク2: DecoratorInfo型を定義する

**状態**: pending
**Phase**: 1
**参照設計書**: [02.models.md](./02.models.md#decoratorinfo型)

**作業内容**:
1. `src/types/nestjs.ts` にDecoratorInfo型を追加
2. パラメーターデコレーター情報型を追加

**担当ファイル**:
- `src/types/nestjs.ts`

**完了条件**:
- [ ] DecoratorInfo型が設計書と一致
- [ ] ParamDecoratorInfo型が設計書と一致

---

### タスク3: 設定ファイル型を定義する

**状態**: pending
**Phase**: 1
**参照設計書**: [05.config-file.md](./05.config-file.md#型定義)

**作業内容**:
1. `src/types/config.ts` を新規作成
2. ExtractorConfig型を定義
3. NestJSConfig型を定義
4. NestJSAuthConfigFile型を定義

**担当ファイル**:
- `src/types/config.ts`（新規）

**完了条件**:
- [ ] 全型が設計書と一致
- [ ] index.tsからエクスポートされている
- [ ] TypeScriptエラーがない

---

### タスク4: デフォルト設定値を定義する

**状態**: pending
**Phase**: 1
**参照設計書**: [05.config-file.md](./05.config-file.md#デフォルト値)

**作業内容**:
1. `src/config/defaults.ts` を新規作成
2. DEFAULT_EXTRACTOR_CONFIG を定義
3. guardPatterns, publicDecorators等のデフォルト値を設定

**担当ファイル**:
- `src/config/defaults.ts`（新規）

**完了条件**:
- [ ] デフォルト値が設計書と一致
- [ ] TypeScriptエラーがない

---

### タスク5: NestJSExtractorインターフェースを実装する

**状態**: pending
**Phase**: 1
**参照設計書**: [02.models.md](./02.models.md#nestjsextractor)

**作業内容**:
1. `src/extractors/nestjs/index.ts` を新規作成
2. EndpointExtractorインターフェースを実装
3. extract()メソッドのスケルトン実装
4. canHandle()メソッドを実装

**担当ファイル**:
- `src/extractors/nestjs/index.ts`（新規）

**完了条件**:
- [ ] EndpointExtractorインターフェースを実装
- [ ] canHandle()が@nestjs/commonを検出

---

### タスク6: 設定ファイル読み込みテストを作成する

**状態**: pending
**Phase**: 2
**参照設計書**: [05.config-file.md](./05.config-file.md#設定読み込みロジック)

**作業内容**:
1. `src/__tests__/config/loader.test.ts` を作成
2. YAML読み込みテストを作成
3. JSON読み込みテストを作成
4. マージ優先順位テストを作成
5. デフォルト値適用テストを作成

**担当ファイル**:
- `src/__tests__/config/loader.test.ts`（新規）
- `src/__tests__/fixtures/config.fixture.ts`（新規）

**完了条件**:
- [ ] 全テストケースが実装されている
- [ ] テストが実行可能（FAILするのが正常）

---

### タスク7: デコレーターパーサー用テストを作成する

**状態**: pending
**Phase**: 2
**参照設計書**: [03.tests.md](./03.tests.md#decoratorparser)

**作業内容**:
1. `src/__tests__/fixtures/nestjs.fixture.ts` を作成
2. `src/__tests__/nestjs/decoratorParser.test.ts` を作成
3. HTTPメソッドデコレーター検出テストを作成
4. パラメーターデコレーター検出テストを作成
5. UseGuardsデコレーター検出テストを作成

**担当ファイル**:
- `src/__tests__/fixtures/nestjs.fixture.ts`（新規）
- `src/__tests__/nestjs/decoratorParser.test.ts`（新規）

**完了条件**:
- [ ] 全フィクスチャが定義されている
- [ ] 全テストケースが実装されている
- [ ] テストが実行可能（FAILするのが正常）

---

### タスク8: コントローラーパーサー用テストを作成する

**状態**: pending
**Phase**: 2
**参照設計書**: [03.tests.md](./03.tests.md#controllerparser)

**作業内容**:
1. `src/__tests__/nestjs/controllerParser.test.ts` を作成
2. コントローラークラス検出テストを作成
3. ルートメソッド抽出テストを作成
4. パス結合テストを作成

**担当ファイル**:
- `src/__tests__/nestjs/controllerParser.test.ts`（新規）

**完了条件**:
- [ ] 全テストケースが実装されている
- [ ] テストが実行可能（FAILするのが正常）

---

### タスク9: モジュールパーサー用テストを作成する

**状態**: pending
**Phase**: 2
**参照設計書**: [03.tests.md](./03.tests.md#moduleparser)

**作業内容**:
1. `src/__tests__/nestjs/moduleParser.test.ts` を作成
2. コントローラー登録検出テストを作成
3. APP_GUARD検出テストを作成

**担当ファイル**:
- `src/__tests__/nestjs/moduleParser.test.ts`（新規）

**完了条件**:
- [ ] 全テストケースが実装されている
- [ ] テストが実行可能（FAILするのが正常）

---

### タスク10: GuardAnalyzer用テストを作成する

**状態**: pending
**Phase**: 2
**参照設計書**: [04.parser-implementation.md](./04.parser-implementation.md#guardanalyzer)

**作業内容**:
1. `src/__tests__/nestjs/guardAnalyzer.test.ts` を作成
2. AuthGuard継承検出テストを作成
3. パターンマッチテストを作成
4. 設定ファイル指定テストを作成
5. 除外リストテストを作成

**担当ファイル**:
- `src/__tests__/nestjs/guardAnalyzer.test.ts`（新規）
- `src/__tests__/fixtures/guards.fixture.ts`（新規）

**完了条件**:
- [ ] 全テストケースが実装されている
- [ ] AuthGuard継承パターンがテストされている
- [ ] テストが実行可能（FAILするのが正常）

---

### タスク11: ConfigLoaderを実装する

**状態**: pending
**Phase**: 3
**参照設計書**: [04.parser-implementation.md](./04.parser-implementation.md#configloader)

**作業内容**:
1. `src/config/loader.ts` を作成
2. YAML/JSON読み込みを実装
3. package.json読み込みを実装
4. 設定マージロジックを実装

**担当ファイル**:
- `src/config/loader.ts`（新規）

**完了条件**:
- [ ] タスク6のテストがパスする
- [ ] TypeScriptエラーがない

---

### タスク12: GuardAnalyzerを実装する

**状態**: pending
**Phase**: 3
**参照設計書**: [04.parser-implementation.md](./04.parser-implementation.md#guardanalyzer)

**作業内容**:
1. `src/extractors/nestjs/guardAnalyzer.ts` を作成
2. isAuthGuard()を実装
3. checkAuthGuardInheritance()を実装
4. analyzeInheritanceChain()を実装

**担当ファイル**:
- `src/extractors/nestjs/guardAnalyzer.ts`（新規）

**完了条件**:
- [ ] タスク10のテストがパスする
- [ ] AuthGuard継承を正しく検出
- [ ] TypeScriptエラーがない

---

### タスク13: decoratorParser.tsを実装する

**状態**: pending
**Phase**: 3
**参照設計書**: [04.parser-implementation.md](./04.parser-implementation.md#decoratorparser)

**作業内容**:
1. `src/extractors/nestjs/decoratorParser.ts` を作成
2. parseMethodDecorators()を実装
3. parseParamDecorators()を実装
4. parseGuardDecorators()を実装

**担当ファイル**:
- `src/extractors/nestjs/decoratorParser.ts`（新規）

**完了条件**:
- [ ] タスク7のテストがパスする
- [ ] TypeScriptエラーがない

---

### タスク14: controllerParser.tsを実装する

**状態**: pending
**Phase**: 3
**参照設計書**: [04.parser-implementation.md](./04.parser-implementation.md#controllerparser)

**作業内容**:
1. `src/extractors/nestjs/controllerParser.ts` を作成
2. parseController()を実装
3. extractEndpoints()を実装

**担当ファイル**:
- `src/extractors/nestjs/controllerParser.ts`（新規）

**完了条件**:
- [ ] タスク8のテストがパスする
- [ ] TypeScriptエラーがない

---

### タスク15: authDetector.tsを実装する

**状態**: pending
**Phase**: 3
**参照設計書**: [04.parser-implementation.md](./04.parser-implementation.md#authdetector)

**作業内容**:
1. `src/extractors/nestjs/authDetector.ts` を作成
2. detectAuth()を実装（GuardAnalyzer連携）
3. isPublicRoute()を実装
4. collectAndAnalyzeGuards()を実装

**担当ファイル**:
- `src/extractors/nestjs/authDetector.ts`（新規）

**完了条件**:
- [ ] 認証検出テストがパスする
- [ ] @Publicデコレーターを正しく検出
- [ ] GuardAnalyzerと正しく連携

---

### タスク16: moduleParser.tsを実装する

**状態**: pending
**Phase**: 3
**参照設計書**: [04.parser-implementation.md](./04.parser-implementation.md#moduleparser)

**作業内容**:
1. `src/extractors/nestjs/moduleParser.ts` を作成
2. parseModule()を実装
3. extractControllers()を実装
4. detectGlobalGuards()を実装

**担当ファイル**:
- `src/extractors/nestjs/moduleParser.ts`（新規）

**完了条件**:
- [ ] タスク9のテストがパスする
- [ ] TypeScriptエラーがない

---

### タスク17: NestJSExtractorを統合する

**状態**: pending
**Phase**: 3
**参照設計書**: [04.parser-implementation.md](./04.parser-implementation.md#統合)

**作業内容**:
1. NestJSExtractor.extract()を完成させる
2. ConfigLoader, GuardAnalyzer, AuthDetectorを連携
3. 全パーサーを連携させる
4. EndpointInfo形式で出力

**担当ファイル**:
- `src/extractors/nestjs/index.ts`

**完了条件**:
- [ ] 全テストがパスする
- [ ] Fastifyと同形式のEndpointInfoを出力
- [ ] 設定ファイルが正しく読み込まれる

---

### タスク18: CLIに--configオプションを追加する

**状態**: pending
**Phase**: 3
**参照設計書**: [05.config-file.md](./05.config-file.md#cli引数との統合)

**作業内容**:
1. index.tsに--configオプションを追加
2. NestJSExtractorをインポート
3. フレームワーク自動検出ロジックを追加

**担当ファイル**:
- `index.ts`

**完了条件**:
- [ ] --config が認識される
- [ ] --framework nestjsが認識される
- [ ] 自動検出でNestJSプロジェクトを識別

---

## 実装順序の依存関係

```
=== Phase 1: 型定義 ===

タスク1-4 (型定義・設定) ─── 並列実行可能
    │
    ▼
タスク5 (Extractorスケルトン)

=== Phase 2: テスト作成（TDD Red）===

タスク5完了
    │
    ▼
タスク6-10 (テスト作成) ─── 並列実行可能

=== Phase 3: 本実装 ===

タスク6-10完了
    │
    ▼
タスク11-12 (ConfigLoader, GuardAnalyzer) ─── 並列実行可能
    │
    ▼
タスク13-16 (パーサー実装) ─── 並列実行可能
    │
    ▼
タスク17 (統合)
    │
    ▼
タスク18 (CLI対応)
```
