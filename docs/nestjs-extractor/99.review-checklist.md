# レビューチェックリスト: NestJS エンドポイント抽出機能

Updated: 2025/12/30 22:20

## 概要

このファイルはレビューエージェントが参照する品質保証ファイルです。
各設計書の内容に対するレビュー観点を詳細に定義しています。

---

## レビュー観点一覧

| # | 観点ID | 対象設計書 | チェック内容 | 重要度 |
|---|--------|-----------|-------------|--------|
| 1 | TYPE-001 | 02.models.md | MethodDecoratorType型が定義されている | HIGH |
| 2 | TYPE-002 | 02.models.md | ParamDecoratorType型が定義されている | HIGH |
| 3 | TYPE-003 | 02.models.md | ControllerInfo型が定義されている | HIGH |
| 4 | TYPE-004 | 02.models.md | ModuleInfo型が定義されている | HIGH |
| 5 | TYPE-005 | 02.models.md | NestJSAuthConfigFile型が定義されている | HIGH |
| 6 | TYPE-006 | 02.models.md | ExtractorConfig型が定義されている | HIGH |
| 7 | TYPE-007 | 02.models.md | AuthGuardResult型が定義されている | HIGH |
| 8 | TYPE-008 | 02.models.md | DetectedGuard型が定義されている | HIGH |
| 9 | TYPE-009 | 02.models.md | EndpointAuth型が定義されている | HIGH |
| 10 | TEST-001 | 03.tests.md | decoratorParser.test.tsが存在する | HIGH |
| 11 | TEST-002 | 03.tests.md | controllerParser.test.tsが存在する | HIGH |
| 12 | TEST-003 | 03.tests.md | moduleParser.test.tsが存在する | HIGH |
| 13 | TEST-004 | 03.tests.md | authDetector.test.tsが存在する | HIGH |
| 14 | TEST-005 | 03.tests.md | 全フィクスチャが定義されている | HIGH |
| 15 | TEST-006 | 05.config-file.md | configLoader.test.tsが存在する | HIGH |
| 16 | TEST-007 | 04.parser-implementation.md | guardAnalyzer.test.tsが存在する | HIGH |
| 17 | IMPL-001 | 04.parser-implementation.md | DecoratorParserが実装されている | HIGH |
| 18 | IMPL-002 | 04.parser-implementation.md | ControllerParserが実装されている | HIGH |
| 19 | IMPL-003 | 04.parser-implementation.md | ModuleParserが実装されている | HIGH |
| 20 | IMPL-004 | 04.parser-implementation.md | NestJSAuthDetectorが実装されている | HIGH |
| 21 | IMPL-005 | 04.parser-implementation.md | NestJSExtractorが実装されている | HIGH |
| 22 | IMPL-006 | 04.parser-implementation.md | @Get等のHTTPメソッドデコレーターを検出する | HIGH |
| 23 | IMPL-007 | 04.parser-implementation.md | @Param, @Body, @Queryを検出する | HIGH |
| 24 | IMPL-008 | 04.parser-implementation.md | @UseGuardsを検出する | HIGH |
| 25 | IMPL-009 | 04.parser-implementation.md | @Publicを検出する | HIGH |
| 26 | IMPL-010 | 04.parser-implementation.md | APP_GUARDを検出する | HIGH |
| 27 | CONFIG-001 | 05.config-file.md | ConfigLoaderが実装されている | HIGH |
| 28 | CONFIG-002 | 05.config-file.md | YAML設定ファイルを読み込める | HIGH |
| 29 | CONFIG-003 | 05.config-file.md | JSON設定ファイルを読み込める | HIGH |
| 30 | CONFIG-004 | 05.config-file.md | デフォルト設定が正しく適用される | HIGH |
| 31 | CONFIG-005 | 05.config-file.md | 設定のマージが正しく動作する | HIGH |
| 32 | GUARD-001 | 04.parser-implementation.md | GuardAnalyzerが実装されている | HIGH |
| 33 | GUARD-002 | 04.parser-implementation.md | AuthGuard継承を検出する | HIGH |
| 34 | GUARD-003 | 04.parser-implementation.md | パターンマッチで認証ガードを判定する | MEDIUM |
| 35 | GUARD-004 | 04.parser-implementation.md | 設定ファイルで指定されたガードを認識する | HIGH |
| 36 | GUARD-005 | 04.parser-implementation.md | 除外リストのガードを認証ガードとしない | HIGH |
| 37 | INTEG-001 | 04.parser-implementation.md | EndpointInfo形式で出力する | HIGH |
| 38 | INTEG-002 | 04.parser-implementation.md | canHandle()が@nestjs/commonを検出する | HIGH |
| 39 | INTEG-003 | 04.parser-implementation.md | auth.confidenceが正しく設定される | HIGH |
| 40 | CLI-001 | 05.config-file.md | --configオプションが認識される | MEDIUM |
| 41 | CLI-002 | 04.parser-implementation.md | --framework nestjsが認識される | MEDIUM |

---

## 観点詳細

### TYPE-001: MethodDecoratorType型が定義されている

**対象設計書**: [02.models.md](./02.models.md#methoddecoratortype)
**重要度**: HIGH（必須）
**担当ファイル**: `src/types/nestjs.ts`

#### 何をチェックするか

MethodDecoratorType型がGet, Post, Put, Delete, Patch等を含むユニオン型として定義されていること。

#### 期待される状態

```typescript
export type MethodDecoratorType =
  | 'Get'
  | 'Post'
  | 'Put'
  | 'Delete'
  | 'Patch'
  | 'Options'
  | 'Head'
  | 'All';
```

#### NGパターン

```typescript
// NG: 一部のメソッドが欠けている
export type MethodDecoratorType = 'Get' | 'Post';

// NG: 小文字になっている
export type MethodDecoratorType = 'get' | 'post';
```

---

### TYPE-003: ControllerInfo型が定義されている

**対象設計書**: [02.models.md](./02.models.md#controllerinfo型)
**重要度**: HIGH（必須）
**担当ファイル**: `src/types/nestjs.ts`

#### 何をチェックするか

ControllerInfo型に以下のフィールドがあること:
- name: string
- basePath: string
- classGuards: readonly GuardDecoratorInfo[]
- methods: readonly ControllerMethodInfo[]
- sourceFile: string

#### 期待される状態

```typescript
export type ControllerInfo = {
  readonly name: string;
  readonly basePath: string;
  readonly classGuards: readonly GuardDecoratorInfo[];
  readonly classMetadata: readonly MetadataDecoratorInfo[];
  readonly methods: readonly ControllerMethodInfo[];
  readonly sourceFile: string;
  readonly lineNumber: number;
};
```

---

### TEST-001: decoratorParser.test.tsが存在する

**対象設計書**: [03.tests.md](./03.tests.md#decoratorparser)
**重要度**: HIGH（必須）
**担当ファイル**: `src/__tests__/nestjs/decoratorParser.test.ts`

#### 何をチェックするか

1. ファイルが存在すること
2. parseMethodDecoratorのテストがあること
3. parseParamDecoratorsのテストがあること
4. parseGuardDecoratorsのテストがあること

#### チェック手順

```bash
# ファイル存在確認
ls src/__tests__/nestjs/decoratorParser.test.ts

# テストケース確認
grep -E "describe|it\(" src/__tests__/nestjs/decoratorParser.test.ts
```

---

### IMPL-006: @Get等のHTTPメソッドデコレーターを検出する

**対象設計書**: [04.parser-implementation.md](./04.parser-implementation.md#decoratorparser)
**重要度**: HIGH（必須）
**担当ファイル**: `src/extractors/nestjs/decoratorParser.ts`

#### 何をチェックするか

parseMethodDecoratorメソッドが@Get, @Post, @Put, @Delete, @Patchを正しく検出すること。

#### 期待される状態

```typescript
parseMethodDecorator(method: MethodDeclaration): MethodDecoratorInfo | null {
  const decorators = method.getDecorators();
  for (const decorator of decorators) {
    const name = decorator.getName();
    if (HTTP_METHOD_DECORATORS.includes(name)) {
      // デコレーター情報を返す
    }
  }
  return null;
}
```

#### チェック手順

1. decoratorParser.tsを読み込む
2. parseMethodDecoratorメソッドの存在確認
3. HTTP_METHOD_DECORATORSリストの確認
4. テストがパスすることを確認

---

### IMPL-008: @UseGuardsを検出する

**対象設計書**: [04.parser-implementation.md](./04.parser-implementation.md#decoratorparser)
**重要度**: HIGH（必須）
**担当ファイル**: `src/extractors/nestjs/decoratorParser.ts`

#### 何をチェックするか

1. @UseGuards(AuthGuard)パターンを検出すること
2. @UseGuards(Guard1, Guard2)の複数ガードを検出すること
3. クラスレベルとメソッドレベルを区別すること

#### 期待される状態

```typescript
parseGuardDecorators(
  node: MethodDeclaration | ClassDeclaration,
  level: 'method' | 'class'
): readonly GuardDecoratorInfo[] {
  const decorators = node.getDecorators();
  for (const decorator of decorators) {
    if (decorator.getName() === 'UseGuards') {
      // ガード名を抽出
    }
  }
}
```

---

### IMPL-009: @Publicを検出する

**対象設計書**: [04.parser-implementation.md](./04.parser-implementation.md#authdetector)
**重要度**: HIGH（必須）
**担当ファイル**: `src/extractors/nestjs/authDetector.ts`

#### 何をチェックするか

1. @Public()デコレーターを検出すること
2. @Publicがあるルートはrequired: falseになること
3. グローバルガードがあっても@Publicで上書きされること

#### 期待される状態

```typescript
isPublicRoute(controller: ControllerInfo, method: ControllerMethodInfo): boolean {
  for (const meta of method.metadata) {
    if (this.config.publicDecorators.includes(meta.name)) {
      return true;
    }
  }
  return false;
}
```

#### テストケース

```typescript
it('@Public()付きメソッドはrequired: falseを返す', () => {
  // ...
  expect(result.required).toBe(false);
});

it('グローバルガード + @Publicで認証不要', () => {
  // ...
  expect(result.required).toBe(false);
});
```

---

### IMPL-010: APP_GUARDを検出する

**対象設計書**: [04.parser-implementation.md](./04.parser-implementation.md#moduleparser)
**重要度**: HIGH（必須）
**担当ファイル**: `src/extractors/nestjs/moduleParser.ts`

#### 何をチェックするか

```typescript
@Module({
  providers: [
    {
      provide: APP_GUARD,
      useClass: AuthGuard,
    },
  ],
})
```

このパターンからAuthGuardを抽出できること。

#### 期待される状態

```typescript
extractGlobalGuards(config: ObjectLiteralExpression): readonly string[] {
  // providers配列からAPP_GUARD登録を探す
  // useClassの値を返す
}
```

---

### INTEG-001: EndpointInfo形式で出力する

**対象設計書**: [04.parser-implementation.md](./04.parser-implementation.md#統合)
**重要度**: HIGH（必須）
**担当ファイル**: `src/extractors/nestjs/index.ts`

#### 何をチェックするか

NestJSExtractor.extract()の出力がFastifyExtractorと同じExtractedEndpoints型であること。

#### 期待される状態

```typescript
async extract(options: ExtractorOptions): Promise<ExtractedEndpoints> {
  return {
    framework: 'nestjs',
    projectRoot,
    routes: [...],
    extractedAt: new Date().toISOString(),
    authRequiredCount,
    publicCount,
  };
}
```

---

### INTEG-002: canHandle()が@nestjs/commonを検出する

**対象設計書**: [04.parser-implementation.md](./04.parser-implementation.md#統合)
**重要度**: HIGH（必須）
**担当ファイル**: `src/extractors/nestjs/index.ts`

#### 何をチェックするか

package.jsonに@nestjs/commonがある場合にtrueを返すこと。

#### 期待される状態

```typescript
async canHandle(projectRoot: string): Promise<boolean> {
  const packageJson = JSON.parse(await Bun.file(`${projectRoot}/package.json`).text());
  const allDeps = { ...packageJson.dependencies, ...packageJson.devDependencies };
  return '@nestjs/common' in allDeps;
}
```

---

## 設計書別チェックサマリー

### 02.models.md 関連

| 観点ID | 内容 | 完了条件 |
|--------|------|---------|
| TYPE-001 | MethodDecoratorType型 | 8種類のHTTPメソッドを含む |
| TYPE-002 | ParamDecoratorType型 | Param, Body, Query等を含む |
| TYPE-003 | ControllerInfo型 | 全フィールドが存在 |
| TYPE-004 | ModuleInfo型 | controllers, globalGuardsを含む |
| TYPE-005 | NestJSAuthConfigFile型 | publicDecoratorsを含む |
| TYPE-006 | ExtractorConfig型 | common, nestjs, fastifyを含む |
| TYPE-007 | AuthGuardResult型 | isAuth, confidence, reasonを含む |
| TYPE-008 | DetectedGuard型 | name, level, isAuthGuard, reasonを含む |
| TYPE-009 | EndpointAuth型 | required, confidence, guardsを含む |

### 03.tests.md 関連

| 観点ID | 内容 | 完了条件 |
|--------|------|---------|
| TEST-001 | decoratorParser.test.ts | ファイル存在、テストケース網羅 |
| TEST-002 | controllerParser.test.ts | ファイル存在、テストケース網羅 |
| TEST-003 | moduleParser.test.ts | ファイル存在、テストケース網羅 |
| TEST-004 | authDetector.test.ts | ファイル存在、テストケース網羅 |
| TEST-005 | フィクスチャ | 全8種類が定義 |
| TEST-006 | configLoader.test.ts | ファイル存在、YAML/JSON/マージテスト |
| TEST-007 | guardAnalyzer.test.ts | ファイル存在、継承検出テスト |

### 04.parser-implementation.md 関連

| 観点ID | 内容 | 完了条件 |
|--------|------|---------|
| IMPL-001 | DecoratorParser | parseMethodDecorator実装 |
| IMPL-002 | ControllerParser | parseController実装 |
| IMPL-003 | ModuleParser | parseModule実装 |
| IMPL-004 | NestJSAuthDetector | detectAuth実装（GuardAnalyzer連携） |
| IMPL-005 | NestJSExtractor | extract実装（ConfigLoader連携） |
| IMPL-006 | HTTPメソッド検出 | @Get等を検出 |
| IMPL-007 | パラメーター検出 | @Param等を検出 |
| IMPL-008 | ガード検出 | @UseGuardsを検出 |
| IMPL-009 | Public検出 | @Publicを検出 |
| IMPL-010 | グローバルガード検出 | APP_GUARDを検出 |

### 05.config-file.md 関連

| 観点ID | 内容 | 完了条件 |
|--------|------|---------|
| CONFIG-001 | ConfigLoader | load()が実装されている |
| CONFIG-002 | YAML読み込み | extractor.config.yamlを読み込む |
| CONFIG-003 | JSON読み込み | extractor.config.jsonを読み込む |
| CONFIG-004 | デフォルト設定 | DEFAULT_EXTRACTOR_CONFIGが適用される |
| CONFIG-005 | 設定マージ | 優先順位に従いマージされる |

### GuardAnalyzer 関連

| 観点ID | 内容 | 完了条件 |
|--------|------|---------|
| GUARD-001 | GuardAnalyzer | isAuthGuard()が実装されている |
| GUARD-002 | AuthGuard継承検出 | extends AuthGuard('xxx')を検出 |
| GUARD-003 | パターンマッチ | guardPatternsに基づき判定 |
| GUARD-004 | 設定指定 | authGuardsリストを認識 |
| GUARD-005 | 除外リスト | excludeGuardsを認識 |

---

## レビュー実行手順

1. このファイルを読み込む
2. 「レビュー観点一覧」の各観点について順番にチェック
3. 「観点詳細」セクションで詳細なチェック手順を確認
4. 各観点について PASS/FAIL を判定
5. FAILの場合は設計書を参照して修正指示を出力
6. レビュー結果を出力

## レビュー結果フォーマット

```markdown
# レビュー結果: NestJS エンドポイント抽出機能

実施日時: YYYY/MM/DD HH:mm

## サマリー

- PASS: X件
- FAIL: Y件
- SKIP: Z件

## 詳細

### PASS

| 観点ID | 内容 | 確認ファイル |
|--------|------|-------------|
| TYPE-001 | MethodDecoratorType型 | src/types/nestjs.ts:5 |

### FAIL

| 観点ID | 内容 | 問題 | 修正指示 |
|--------|------|------|---------|
| IMPL-009 | @Public検出 | 未実装 | 04.parser-implementation.mdの仕様に従い実装 |
```
