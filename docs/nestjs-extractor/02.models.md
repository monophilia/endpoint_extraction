# モデル設計: NestJS エンドポイント抽出

Updated: 2025/12/30 22:20

## 目的

NestJS固有のデコレーター情報を表現する型を定義し、既存のEndpointInfo型への変換を可能にする。

---

## NestJS固有型

### MethodDecoratorType

HTTPメソッドデコレーターの種類を表す型。

```typescript
// src/types/nestjs.ts

export type MethodDecoratorType =
  | 'Get'
  | 'Post'
  | 'Put'
  | 'Delete'
  | 'Patch'
  | 'Options'
  | 'Head'
  | 'All';
```

### HttpMethodMap

デコレーター名からHttpMethodへの変換マップ。

```typescript
export const HTTP_METHOD_MAP: Record<MethodDecoratorType, HttpMethod> = {
  Get: 'GET',
  Post: 'POST',
  Put: 'PUT',
  Delete: 'DELETE',
  Patch: 'PATCH',
  Options: 'OPTIONS',
  Head: 'HEAD',
  All: 'ALL',
} as const;
```

---

## DecoratorInfo型

### MethodDecoratorInfo

HTTPメソッドデコレーターの情報。

```typescript
export type MethodDecoratorInfo = {
  /** デコレーター種別 */
  readonly type: MethodDecoratorType;
  /** パス引数（@Get(':id')の':id'部分） */
  readonly path: string;
  /** 行番号 */
  readonly lineNumber: number;
};
```

### ParamDecoratorType

パラメーターデコレーターの種類。

```typescript
export type ParamDecoratorType =
  | 'Param'
  | 'Body'
  | 'Query'
  | 'Headers'
  | 'Req'
  | 'Res';
```

### ParamDecoratorInfo

パラメーターデコレーターの情報。

```typescript
export type ParamDecoratorInfo = {
  /** デコレーター種別 */
  readonly type: ParamDecoratorType;
  /** 引数名（@Param('id')の'id'部分、省略時はundefined） */
  readonly argName?: string;
  /** パラメーター名（メソッド引数名） */
  readonly paramName: string;
  /** 型情報 */
  readonly paramType: string;
  /** 必須かどうか */
  readonly required: boolean;
};
```

### GuardDecoratorInfo

UseGuardsデコレーターの情報。

```typescript
export type GuardDecoratorInfo = {
  /** ガード名リスト */
  readonly guards: readonly string[];
  /** 適用レベル（class: コントローラー, method: メソッド） */
  readonly level: 'class' | 'method';
  /** 行番号 */
  readonly lineNumber: number;
};
```

### MetadataDecoratorInfo

SetMetadata系デコレーターの情報。

```typescript
export type MetadataDecoratorInfo = {
  /** デコレーター名（Public, Roles等） */
  readonly name: string;
  /** メタデータキー */
  readonly key: string;
  /** メタデータ値 */
  readonly value: unknown;
  /** 行番号 */
  readonly lineNumber: number;
};
```

---

## ControllerInfo型

コントローラークラスの解析結果。

```typescript
export type ControllerInfo = {
  /** コントローラー名 */
  readonly name: string;
  /** ベースパス（@Controller('cats')の'cats'） */
  readonly basePath: string;
  /** クラスレベルのガード */
  readonly classGuards: readonly GuardDecoratorInfo[];
  /** クラスレベルのメタデータ */
  readonly classMetadata: readonly MetadataDecoratorInfo[];
  /** メソッド情報 */
  readonly methods: readonly ControllerMethodInfo[];
  /** ソースファイルパス */
  readonly sourceFile: string;
  /** 行番号 */
  readonly lineNumber: number;
};
```

### ControllerMethodInfo

コントローラーメソッドの解析結果。

```typescript
export type ControllerMethodInfo = {
  /** メソッド名 */
  readonly name: string;
  /** HTTPメソッドデコレーター */
  readonly httpMethod: MethodDecoratorInfo;
  /** パラメーターデコレーター */
  readonly params: readonly ParamDecoratorInfo[];
  /** メソッドレベルのガード */
  readonly guards: readonly GuardDecoratorInfo[];
  /** メソッドレベルのメタデータ */
  readonly metadata: readonly MetadataDecoratorInfo[];
  /** 行番号 */
  readonly lineNumber: number;
};
```

---

## ModuleInfo型

モジュールの解析結果。

```typescript
export type ModuleInfo = {
  /** モジュール名 */
  readonly name: string;
  /** 登録されたコントローラー */
  readonly controllers: readonly ControllerRegistration[];
  /** グローバルガード（APP_GUARD） */
  readonly globalGuards: readonly string[];
  /** ソースファイルパス */
  readonly sourceFile: string;
};

export type ControllerRegistration = {
  /** コントローラー名 */
  readonly name: string;
  /** インポート元パス */
  readonly importPath: string;
  /** 解決済みファイルパス */
  readonly resolvedPath: string;
};
```

---

## NestJSExtractor

既存のEndpointExtractorインターフェースを実装。

```typescript
// src/extractors/nestjs/index.ts

import type { EndpointExtractor } from '../types';
import type { ExtractorOptions, ExtractedEndpoints, FrameworkType } from '../../types';

export class NestJSExtractor implements EndpointExtractor {
  readonly framework: FrameworkType = 'nestjs';

  async extract(options: ExtractorOptions): Promise<ExtractedEndpoints> {
    // 実装
  }

  async canHandle(projectRoot: string): Promise<boolean> {
    // @nestjs/common の存在チェック
  }
}
```

---

## 設定ファイル型

詳細は [05.config-file.md](./05.config-file.md) を参照。

### ExtractorConfig

```typescript
// src/types/config.ts

/**
 * エクストラクター設定ファイルの型
 */
export type ExtractorConfig = {
  readonly common?: CommonConfig;
  readonly nestjs?: NestJSConfig;
  readonly fastify?: FastifyConfig;
};

/**
 * 共通設定
 */
export type CommonConfig = {
  readonly outputFormat?: 'yaml' | 'json';
  readonly extractResponses?: boolean;
  readonly responseDepth?: number;
};

/**
 * NestJS固有設定
 */
export type NestJSConfig = {
  readonly auth?: NestJSAuthConfigFile;
  readonly params?: NestJSParamsConfig;
};

/**
 * NestJS認証設定（設定ファイル用）
 */
export type NestJSAuthConfigFile = {
  /** 認証ガードとして扱うガード名パターン（正規表現） */
  readonly guardPatterns?: readonly string[];
  /** 明示的に認証ガードとして扱うガード名 */
  readonly authGuards?: readonly string[];
  /** 認証ガードから除外するガード名 */
  readonly excludeGuards?: readonly string[];
  /** 公開エンドポイントを示すデコレーター名 */
  readonly publicDecorators?: readonly string[];
  /** 公開エンドポイントを示すメタデータキー */
  readonly publicMetadataKeys?: readonly string[];
};
```

---

## 認証判定ロジック

### ガード判定結果型

```typescript
// src/types/nestjs.ts

/**
 * 認証ガード判定結果
 */
export type AuthGuardResult = {
  /** 認証ガードかどうか */
  readonly isAuth: boolean;
  /** 判定の確信度 */
  readonly confidence: 'high' | 'medium' | 'low';
  /** 判定理由 */
  readonly reason: 'config' | 'pattern' | 'inheritance' | 'excluded' | 'unknown';
};

/**
 * 検出されたガード情報
 */
export type DetectedGuard = {
  /** ガード名 */
  readonly name: string;
  /** 適用レベル */
  readonly level: 'class' | 'method' | 'global';
  /** 認証ガードか */
  readonly isAuthGuard: boolean;
  /** 判定理由 */
  readonly reason: 'config' | 'pattern' | 'inheritance' | 'excluded' | 'unknown';
};

/**
 * エンドポイントの認証情報（拡張版）
 */
export type EndpointAuth = {
  /** 認証が必要か */
  readonly required: boolean | 'unknown';
  /** 判定の確信度 */
  readonly confidence: 'high' | 'medium' | 'low';
  /** 検出されたガード情報 */
  readonly guards: readonly DetectedGuard[];
};
```

### 認証判定フロー（改訂版）

```
1. 設定ファイルを読み込み（ConfigLoader）

2. ガードが認証ガードかを判定（GuardAnalyzer）
   a. 除外リストに含まれる → 認証ガードではない (confidence: high)
   b. 設定ファイルで明示指定 → 認証ガード (confidence: high)
   c. パターンマッチ（.*AuthGuard$等） → 認証ガード (confidence: medium)
   d. AuthGuard継承を検出 → 認証ガード (confidence: high)
   e. いずれにも該当しない → 認証ガードではない (confidence: low)

3. エンドポイントごとに認証要否を判定
   a. @Publicデコレーター付与 → 認証不要
   b. 認証ガードが適用されている → 認証必須
   c. いずれにも該当しない → unknown

4. 最終判定
   required = has_auth_guard AND NOT has_public_decorator
```

### AuthGuard継承検出

プロジェクト固有のガード名に依存せず、`AuthGuard`（@nestjs/passport）を継承しているクラスを自動検出する。

```typescript
// 検出対象パターン
@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') { ... }

@Injectable()
export class CustomAuthGuard extends AuthGuard('custom') { ... }

// 間接継承も検出
@Injectable()
export class MyGuard extends JwtAuthGuard { ... }  // JwtAuthGuardがAuthGuardを継承
```

---

## EndpointInfoへの変換

### 変換関数

```typescript
function toEndpointInfo(
  controller: ControllerInfo,
  method: ControllerMethodInfo,
  globalGuards: readonly string[],
  authConfig: NestJSAuthConfig,
): EndpointInfo {
  const fullPath = joinPaths(controller.basePath, method.httpMethod.path);

  return {
    path: fullPath,
    method: HTTP_METHOD_MAP[method.httpMethod.type],
    pathParams: extractPathParams(method.params),
    queryParams: extractQueryParams(method.params),
    bodyParams: extractBodyParams(method.params),
    auth: detectAuth(controller, method, globalGuards, authConfig),
    sourceFile: controller.sourceFile,
    lineNumber: method.lineNumber,
  };
}
```

---

## ファイル構成

| ファイル | 内容 |
|----------|------|
| `src/types/nestjs.ts` | NestJS固有の型定義 |
| `src/types/config.ts` | 設定ファイル型定義 |
| `src/types/index.ts` | エクスポート追加 |
| `src/config/defaults.ts` | デフォルト設定値 |
| `src/config/loader.ts` | 設定ファイル読み込み |
| `src/extractors/nestjs/index.ts` | NestJSExtractorクラス |
| `src/extractors/nestjs/decoratorParser.ts` | デコレーター解析 |
| `src/extractors/nestjs/controllerParser.ts` | コントローラー解析 |
| `src/extractors/nestjs/moduleParser.ts` | モジュール解析 |
| `src/extractors/nestjs/authDetector.ts` | 認証検出 |
| `src/extractors/nestjs/guardAnalyzer.ts` | ガード解析・継承チェック |
